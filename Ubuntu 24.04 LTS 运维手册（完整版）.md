# Ubuntu 24.04 LTS 运维手册（完整版）

# 01-系统基础操作.md

![License: MIT](https://img.shields.io/badge/License-MIT-yellow.svg)

## 📌 章节简介

涵盖Ubuntu 24.04 LTS系统启动重启、信息查看核心指令，适用于日常运维中的系统基础管控与信息核查场景，为后续运维操作奠定基础。

## 🔧 核心指令清单

|指令|核心功能|风险等级|依赖条件|
|---|---|---|---|
|reboot|重启系统|低|无|
|shutdown|关闭/重启系统|低|无|
|systemctl reboot|通过systemd管理系统重启|低|无|
|halt（冷门实用）|停止系统运行，等同于立即关机|低|无|
|uname|查看系统内核信息|低|无|
|lsb_release -a|查看Ubuntu系统版本信息|低|无|
|hostname|查看/设置主机名|低|无|
|timedatectl|查看/设置系统时间与时区|低|无|
|dmidecode（冷门实用）|查看硬件信息|低|无，需root权限|
## 📋 详细操作指南

### 系统启动与重启

#### 指令1：reboot

- **功能**：重启系统

- **参数**：
        

    - -f：强制重启，跳过正常关闭流程

    - -p：重启后切断电源

- **实操示例**：
`reboot  # 正常重启
reboot -f  # 强制重启
reboot -p  # 重启后切断电源`

- **风险等级**：低

- **注意事项**：强制重启可能导致未保存数据丢失，建议优先正常重启，重启前关闭重要服务与应用。

- **依赖条件**：无

#### 指令2：shutdown

- **功能**：关闭/重启系统

- **参数**：
        

    - -h now：立即关机

    - -r 10：10分钟后重启

    - -c：取消已计划的关机/重启任务

- **实操示例**：
        `shutdown -h now  # 立即关机
shutdown -h 22:00  # 晚22点关机
shutdown -r 10  # 10分钟后重启
shutdown -c  # 取消已计划的关机/重启任务`

- **风险等级**：低

- **注意事项**：计划关机/重启前，需通知相关用户保存数据，避免影响业务运行。

- **依赖条件**：无

#### 指令3：systemctl reboot

- **功能**：通过systemd管理系统重启，Ubuntu 24.04默认推荐

- **参数**：无核心参数，可配合systemd其他选项使用

- **实操示例**：`systemctl reboot  # 正常重启系统`

- **风险等级**：低

- **注意事项**：遵循systemd管理规范，重启前可通过systemctl status查看重要服务状态。

- **依赖条件**：无，Ubuntu 24.04默认预装systemd

#### 指令4：halt（冷门实用）

- **功能**：停止系统运行，等同于shutdown -h now

- **参数**：无核心参数

- **实操示例**：
        `halt  # 停止系统运行，等同于立即关机`

- **风险等级**：低

- **注意事项**：执行后直接关机，需提前保存所有操作数据，适合快速关机场景。

- **依赖条件**：无

### 系统信息查看

#### 指令1：uname

- **功能**：查看系统内核信息

- **参数**：
        

    - -a：显示完整信息，含内核版本、主机名、硬件架构

    - -r：仅显示内核版本

- **实操示例**：
        `uname -a  # 显示完整内核信息
uname -r  # 仅显示内核版本`

- **风险等级**：低

- **注意事项**：纯信息查看指令，无修改操作，可随时执行。

- **依赖条件**：无

#### 指令2：lsb_release -a

- **功能**：查看Ubuntu系统版本信息，Ubuntu专属

- **参数**：-a：显示完整版本信息，含发行版名称、版本号、代号

- **实操示例**：
        `lsb_release -a  # 显示Ubuntu系统完整版本信息`

- **风险等级**：低

- **注意事项**：仅适用于Ubuntu系统，可快速确认系统版本是否为24.04 LTS。

- **依赖条件**：无，Ubuntu默认预装

#### 指令3：hostname

- **功能**：查看/设置主机名

- **参数**：
       

    - -I：显示所有网卡的IP地址，无主机名映射

- **实操示例**：
        `hostname  # 查看当前主机名
hostname new-hostname  # 临时设置主机名，重启失效
hostname -I  # 显示所有网卡IP地址`

- **风险等级**：低

- **注意事项**：临时设置的主机名重启后失效，如需永久修改，需编辑/etc/hostname文件；IP地址显示需确保网卡正常启用。

- **依赖条件**：无

#### 指令4：timedatectl

- **功能**：查看/设置系统时间与时区

- **参数**：
        

    - set-timezone Asia/Shanghai：设置时区为上海

    - status：查看时间状态

- **实操示例**：
       `timedatectl status  # 查看系统时间与时区状态
timedatectl set-timezone Asia/Shanghai  # 设置时区为上海`

- **风险等级**：低

- **注意事项**：时区设置需root权限，修改后会立即生效，建议与网络时间同步工具配合使用，确保时间准确性。

- **依赖条件**：无

#### 指令5：dmidecode（冷门实用）

- **功能**：查看硬件信息，需root权限

- **参数**：
        

    - -t memory：查看内存信息

    - -t cpu：查看CPU信息

- **实操示例**：
        `sudo dmidecode -t cpu  # 查看CPU硬件信息
sudo dmidecode -t memory  # 查看内存硬件信息`

- **风险等级**：低

- **注意事项**：必须使用root权限执行，纯硬件信息读取指令，无修改操作，可用于硬件排查与核对场景。

- **依赖条件**：无，默认预装

# 02-文件目录管理.md

![License: MIT](https://img.shields.io/badge/License-MIT-yellow.svg)

## 📌 章节简介

包含Ubuntu 24.04 LTS系统目录切换、查看、创建、删除、复制等核心指令，适用于日常文件与目录的全流程运维管控，是基础运维操作的核心模块。

## 🔧 核心指令清单

|指令|核心功能|风险等级|依赖条件|
|---|---|---|---|
|cd|切换工作目录|低|无|
|ls|列出目录内容|低|无|
|pwd|显示当前工作目录路径|低|无|
|tree（冷门实用）|以树形结构显示目录层级|低|需安装tree工具包|
|mkdir|创建目录|低|无|
|touch|创建空文件或修改文件时间戳|低|无|
|cp|复制文件/目录|低|无|
|mv|移动/重命名文件/目录|低|无|
|rm|删除文件/目录|高危|无|
|rsync（冷门实用）|高效复制文件，支持增量复制|低|无，默认预装|
## 📋 详细操作指南

### 目录切换与查看

#### 指令1：cd

- **功能**：切换工作目录

- **参数**：
        

    - ~：切换到当前用户家目录

    - ..：切换到上级目录

    - -：切换到上一次工作目录

- **实操示例**：
        `cd /home/ubuntu  # 切换到指定目录
cd ~  # 切换到当前用户家目录
cd ..  # 切换到上级目录
cd -  # 切换到上一次工作目录`

- **风险等级**：低

- **注意事项**：切换目录时需确保路径存在，路径中的用户名（如ubuntu）需根据实际环境修改。

- **依赖条件**：无

#### 指令2：ls

- **功能**：列出目录内容

- **参数**：
        

    - -l：以详细格式显示，含权限、大小、修改时间

    - -a：显示隐藏文件，以.开头

    - -h：大小以人类可读格式显示，如KB、MB

- **实操示例**：
        `ls -la /home  # 以详细格式显示/home目录内容，含隐藏文件
ls -h /data  # 以人类可读格式显示/data目录内容大小
ls  # 简单列出当前目录内容`

- **风险等级**：低

- **注意事项**：纯信息查看指令，可组合参数使用，满足不同查看需求。

- **依赖条件**：无

#### 指令3：pwd

- **功能**：显示当前工作目录路径

- **参数**：无核心参数

- **实操示例**：
        `pwd  # 显示当前工作目录完整路径`

- **风险等级**：低

- **注意事项**：可快速确认当前所在目录，避免因路径混淆执行错误操作。

- **依赖条件**：无

#### 指令4：tree（冷门实用）

- **功能**：以树形结构显示目录层级

- **参数**：
        

    - -L 2：仅显示2级目录

    - -a：包含隐藏文件

- **实操示例**：
        `sudo apt install tree  # 安装tree工具包
tree -L 2 /etc  # 以树形结构显示/etc目录2级层级
tree -a /home/ubuntu  # 显示/home/ubuntu目录层级，含隐藏文件`

- **风险等级**：低

- **注意事项**：目录层级较深时，建议限制显示级别，避免输出内容过多；路径需根据实际环境修改。

- **依赖条件**：需安装tree工具包，安装命令：apt install tree

### 文件/目录创建、删除与复制

#### 指令1：mkdir

- **功能**：创建目录

- **参数**：
        

    - -p：递归创建多级目录，父目录不存在时自动创建

    - -m 755：创建时指定权限为755

- **实操示例**：
        `mkdir -p /data/logs  # 递归创建多级目录
mkdir -m 755 /data/test  # 创建目录并指定权限为755
mkdir docs  # 创建当前目录下的docs目录`

- **风险等级**：低

- **注意事项**：创建目录时需确保当前用户有对应路径的写入权限，路径需根据实际环境修改。

- **依赖条件**：无

#### 指令2：touch

- **功能**：创建空文件或修改文件时间戳

- **参数**：
        

    - -d "时间字符串"：修改文件时间戳为指定时间

- **实操示例**：
        `touch test.txt  # 创建空文件
touch -d "2024-01-01" test.txt  # 修改文件时间戳为2024年1月1日
touch file1.txt file2.txt  # 同时创建多个空文件`

- **风险等级**：低

- **注意事项**：若文件已存在，执行touch指令会更新其时间戳，不会修改文件内容。

- **依赖条件**：无

#### 指令3：cp

- **功能**：复制文件/目录

- **参数**：
        

    - -r：递归复制目录及内容

    - -p：保留文件原有属性，如权限、时间戳

    - -a：等同于-rp，适用于目录备份

- **实操示例**：
        `cp -a /home/test /data/  # 复制目录并保留属性
cp test.txt /data/  # 复制文件到/data目录
cp -p file1.txt file2.txt  # 复制文件并保留原有属性`

- **风险等级**：低

- **注意事项**：复制目录时必须添加-r或-a参数，否则会报错；目标路径已存在同名文件/目录时会覆盖，建议提前确认。

- **依赖条件**：无

#### 指令4：mv

- **功能**：移动/重命名文件/目录

- **参数**：
        

    - -f：强制覆盖目标文件，无提示

- **实操示例**：
        `mv test.txt /data/  # 移动文件到/data目录
mv oldname.txt newname.txt  # 重命名文件
mv -f /data/test.txt /home/  # 强制移动并覆盖目标文件`

- **风险等级**：低

- **注意事项**：移动跨文件系统的目录时，本质是复制后删除原目录；使用-f参数时需谨慎，避免误覆盖重要文件。

- **依赖条件**：无

#### 指令5：rm

- **功能**：删除文件/目录

- **参数**：


    - -r：递归删除目录及内容

    - -f：强制删除，无提示

    - --preserve-root：保护根目录，避免误删

- **实操示例**：
        `rm -rf --preserve-root /data/test  # 删除目录，保护根目录
rm test.txt  # 删除文件
rm -f file1.txt file2.txt  # 强制删除多个文件`

- **风险等级**：高危

- **注意事项**：执行rm -rf /会删除系统所有文件，导致系统崩溃，务必谨慎操作。执行前确认路径无误，优先使用--preserve-root参数，重要文件先备份；删除操作不可逆，需反复核对目标对象。

- **依赖条件**：无

#### 指令6：rsync（冷门实用）

- **功能**：高效复制文件，支持增量复制

- **参数**：


    - -a：归档模式，保留属性

    - -v：显示复制过程

    - -z：压缩传输

- **实操示例**：
        `rsync -avz /home/test /data/  # 增量复制文件，保留属性并显示过程
rsync -av /data/logs/ /backup/logs/  # 同步目录内容（注意末尾/）`

- **风险等级**：低

- **注意事项**：源目录末尾加/表示复制目录内内容，不加则复制目录本身；增量复制适合大文件或频繁同步场景，效率高于cp指令。

- **依赖条件**：无，默认预装

# 03-用户与权限管理.md

![License: MIT](https://img.shields.io/badge/License-MIT-yellow.svg)

## 📌 章节简介

涵盖Ubuntu 24.04 LTS系统用户与组管理、基础权限配置及ACL权限管控指令，适用于系统权限分配与安全管控场景，保障系统访问安全。

## 🔧 核心指令清单

|指令|核心功能|风险等级|依赖条件|
|---|---|---|---|
|useradd|创建用户|中|无，需root权限|
|passwd|设置/修改用户密码|中|无，root可修改所有用户密码|
|userdel|删除用户|中|无，需root权限|
|groupadd|创建用户组|中|无，需root权限|
|usermod|修改用户属性|中|无，需root权限|
|id|查看用户ID、组ID及所属组|低|无|
|groups|查看用户所属的所有组|低|无|
|chage（冷门实用）|修改用户密码过期策略|中|无，需root权限|
|chmod|修改文件/目录权限|中|无，所有者可修改自身文件权限|
|chown|修改文件/目录所有者及组|中|无，需root权限或文件所有者|
|umask|查看/设置默认文件权限|低|无|
|getfacl|查看文件/目录的ACL权限|低|需安装acl工具包|
|setfacl|设置文件/目录的ACL权限|中|需安装acl工具包|
|setfacl -b（冷门实用）|清除文件/目录的所有ACL权限|中|需安装acl工具包|
## 📋 详细操作指南

### 用户与组管理

#### 指令1：useradd

- **功能**：创建用户

- **参数**：
        

    - -m：自动创建用户家目录

    - -s /bin/bash：指定默认shell

    - -g 组名：指定主组

- **实操示例**：
        `sudo useradd -m -s /bin/bash -g users testuser  # 创建用户并指定主组
sudo useradd -m newuser  # 创建用户并自动生成家目录
sudo useradd -s /sbin/nologin guest  # 创建无法登录的系统用户`

- **风险等级**：中

- **注意事项**：必须使用root权限执行，创建用户后需及时设置密码，否则用户无法登录；用户名、组名需根据实际环境修改，避免与系统用户冲突。

- **依赖条件**：无，需root权限

#### 指令2：passwd

- **功能**：设置/修改用户密码

- **参数**：
        

    - -l：锁定用户，禁止登录

    - -u：解锁用户

- **实操示例**：`passwd testuser  # 普通用户修改自身密码，root修改指定用户密码
sudo passwd -l testuser  # 锁定testuser用户
sudo passwd -u testuser  # 解锁testuser用户
sudo passwd  # root修改自身密码`

- **风险等级**：中

- **注意事项**：锁定用户后，该用户无法通过密码登录，但仍可通过密钥等其他方式登录；设置密码时建议遵循复杂度要求，避免弱密码。

- **依赖条件**：无，root用户可修改所有用户密码，普通用户仅可修改自身密码

#### 指令3：userdel

- **功能**：删除用户

- **参数**：
    -r：同时删除用户家目录及邮件目录

- -f：强制删除，即使用户已登录

- **实操示例**：
    `sudo userdel -r testuser  # 删除用户并移除家目录
sudo userdel -f guest  # 强制删除已登录的guest用户
` `sudo userdel newuser  # 仅删除用户，保留家目录`

- **风险等级**：中

- **注意事项**：删除用户前需确认该用户无正在运行的进程，避免影响业务；使用-r参数时会彻底删除家目录数据，需提前备份重要文件；强制删除已登录用户可能导致进程异常，建议优先让用户退出登录。

- **依赖条件**：无，需root权限

**实操示例**：
   `sudo userdel -r testuser  # 删除用户并移除家目录
sudo userdel -f guest  # 强制删除已登录的guest用户
` `sudo userdel newuser  # 仅删除用户，保留家目录`

**风险等级**：中

**注意事项**：删除用户前需确认该用户无正在运行的进程，避免影响业务；使用-r参数时会彻底删除家目录数据，需提前备份重要文件；强制删除已登录用户可能导致进程异常，建议优先让用户退出登录。

**依赖条件**：无，需root权限

#### 指令4：groupadd

- **功能**：创建用户组

- **参数**：
    -g GID：指定组ID，不指定则自动分配（Ubuntu默认从1000开始）

- -r：创建系统组，GID范围符合系统默认规则（通常为0-999）

- **实操示例**：
    `sudo groupadd -g 1005 devgroup  # 创建指定GID的用户组
sudo groupadd -r sysgroup  # 创建系统组
` `sudo groupadd testgroup  # 默认创建普通用户组`

- **风险等级**：中

- **注意事项**：指定GID时需确保不与现有组ID冲突，可通过cat /etc/group查看已存在组信息；系统组通常用于系统服务，避免用于普通用户授权；组名建议贴合业务场景（如dev、test），便于权限管理。

- **依赖条件**：无，需root权限

**实操示例**：
    `sudo groupadd -g 1005 devgroup  # 创建指定GID的用户组
sudo groupadd -r sysgroup  # 创建系统组
` `sudo groupadd testgroup  # 默认创建普通用户组`

**风险等级**：中

**注意事项**：指定GID时需确保不与现有组ID冲突，可通过cat /etc/group查看已存在组信息；系统组通常用于系统服务，避免用于普通用户授权。

**依赖条件**：无，需root权限

#### 指令5：usermod

- **功能**：修改用户属性，含组归属、家目录、shell等

- **参数**：
    -g 组名/组ID：修改用户主组

- -G 组名1,组名2：添加用户到附加组（覆盖原有附加组，保留主组）

- -d /home/newdir：修改用户家目录路径

- -m：配合-d参数，自动创建新家目录并迁移旧数据

- -s /bin/zsh：修改用户默认登录shell

- **实操示例**：
    `sudo usermod -g devgroup testuser  # 修改用户主组
sudo usermod -G devgroup,testgroup testuser  # 添加用户到多个附加组
sudo usermod -d /home/newtest -m testuser  # 修改家目录并迁移数据
` `sudo usermod -s /bin/zsh testuser  # 修改默认shell为zsh`

- **风险等级**：中

- **注意事项**：修改家目录后需手动验证权限，确保用户可正常访问；修改shell时需确保指定shell已安装（如zsh需apt install zsh）；用户登录状态下修改属性，部分变更需重新登录生效；避免修改系统用户属性，防止系统异常。

- **依赖条件**：无，需root权限

**实操示例**：
    `sudo usermod -g devgroup testuser  # 修改用户主组
sudo usermod -G devgroup,testgroup testuser  # 添加用户到多个附加组
sudo usermod -d /home/newtest testuser  # 修改用户家目录
` `sudo usermod -s /bin/zsh testuser  # 修改默认shell为zsh`

**风险等级**：中

**注意事项**：修改家目录后需手动迁移原有数据，否则用户登录后无法访问旧数据；修改shell时需确保指定shell已安装（如zsh需apt install zsh）；用户登录状态下修改属性，部分变更需重新登录生效。

**依赖条件**：无，需root权限

#### 指令6：id

- **功能**：查看用户UID、GID及所属组信息

- **参数**：
    -u：仅显示用户UID

- -g：仅显示用户主组GID

**实操示例**：
    `id testuser  # 查看testuser完整ID信息
id -u testuser  # 仅显示testuser的UID
` `id -g testuser  # 仅显示testuser的主组GID`

**风险等级**：低

**注意事项**：纯信息查看指令，可用于快速核对用户身份标识，排查权限分配问题。

**依赖条件**：无

#### 指令7：groups

- **功能**：查看用户所属的所有组（主组+附加组）

- **参数**：无核心参数，指定用户名则查看对应用户，不指定则查看当前用户

- **实操示例**：
    `groups testuser  # 查看testuser所属所有组
` `groups  # 查看当前登录用户所属所有组`

- **风险等级**：低

- **注意事项**：输出结果中第一个组为用户主组，后续为附加组，可快速验证用户组归属配置是否生效。

- **依赖条件**：无

#### 指令8：chage（冷门实用）

- **功能**：修改用户密码过期策略，强化系统密码安全，适用于企业级权限管控

- **参数**：
    -M 90：密码最长有效期90天，到期需修改

- -m 7：密码最小修改间隔7天，防止频繁改密码

- -W 7：密码过期前7天向用户发送提醒

- -l：查看用户密码过期详细信息

- -E 2024-12-31：设定用户账号过期时间，到期无法登录

- **实操示例**：
    `sudo chage -M 90 -m 7 -W 7 testuser  # 配置密码过期策略
sudo chage -l testuser  # 查看testuser密码过期详情
sudo chage -E 2024-12-31 testuser  # 设定用户账号过期时间
` `sudo chage -d 0 testuser  # 强制用户下次登录修改密码`

- **风险等级**：中

- **注意事项**：密码有效期设置需结合业务场景，避免过短导致频繁修改；账号过期后用户无法登录，需提前通知用户并做好账号管理；强制下次登录改密码（-d 0）适用于新创建用户或密码泄露场景。

- **依赖条件**：无，需root权限

**实操示例**：
    `sudo chage -M 90 -m 7 -W 7 testuser  # 配置密码过期策略
sudo chage -l testuser  # 查看testuser密码过期详情
` `sudo chage -E 2024-12-31 testuser  # 设定用户账号过期时间`

**风险等级**：中

**注意事项**：密码有效期设置需结合业务场景，避免过短导致频繁修改；账号过期后用户无法登录，需提前通知用户并做好账号管理。

**依赖条件**：无，需root权限

### 权限管理

#### 指令1：chmod

- **功能**：修改文件/目录权限，支持数字权限（r=4、w=2、x=1）和符号权限（u/g/o/a），管控访问权限

- **参数**：
    数字权限：755（所有者rwx、组rx、其他rx）、644（所有者rw、组r、其他r）、777（所有用户rwx，慎用）

- 符号权限：u+x（给所有者加执行权限）、g-w（给组删写入权限）、o=r（给其他设读权限）、a=rwx（给所有用户全权限）

- -R：递归修改目录及所有子内容权限

- **实操示例**：
`chmod 755 test.sh  # 给脚本设置可执行权限
chmod 644 test.txt  # 给文件设置普通读写权限
chmod -R 775 /data/dev  # 递归修改目录及子内容权限
chmod u+x,g+w test.sh  # 给所有者加执行、组加写入权限
` `chmod o-r test.conf  # 取消其他用户对配置文件的读权限`

- **风险等级**：中

- **注意事项**：递归修改目录权限时需谨慎，避免给/etc、/bin等敏感目录设置过宽权限；脚本需添加执行权限（x）才能运行，目录需执行权限才能进入；配置文件建议设为644（仅所有者可写），避免权限泄露。

- **依赖条件**：无，文件所有者或root可修改权限

**实操示例**：
    `chmod 755 test.sh  # 给脚本设置可执行权限
chmod 644 test.txt  # 给文件设置普通读写权限
chmod -R 775 /data/dev  # 递归修改目录及子内容权限
` `chmod u+x,g+w test.sh  # 给所有者加执行、组加写入权限`

**风险等级**：中

**注意事项**：递归修改目录权限时需谨慎，避免给敏感目录（如/etc、/bin）设置过宽权限；脚本需添加执行权限（x）才能运行，目录需执行权限才能进入。

**依赖条件**：无，文件所有者或root可修改权限

#### 指令2：chown

- **功能**：修改文件/目录的所有者及所属组，调整权限归属

- **参数**：
    所有者:所属组：同时修改两者，如testuser:devgroup

- -R：递归修改目录及所有子内容的所有者/组

- **实操示例**：
    `sudo chown testuser:devgroup test.txt  # 修改文件所有者和组
sudo chown -R testuser /home/testdir  # 递归修改目录所有者
sudo chown :devgroup test.sh  # 仅修改文件所属组
` `sudo chown root:root /etc/hosts  # 还原系统文件所有者`

- **风险等级**：中

- **注意事项**：修改权限后可能导致原所有者无法访问文件，需提前确认权限分配合理性；递归修改系统目录所有者可能导致系统异常，严禁随意操作；web服务文件建议将所有者设为服务用户（如www-data），增强安全性。

- **依赖条件**：无，需root权限或文件所有者

**实操示例**：
    `sudo chown testuser:devgroup test.txt  # 修改文件所有者和组
sudo chown -R testuser /home/testdir  # 递归修改目录所有者
` `sudo chown :devgroup test.sh  # 仅修改文件所属组`

**风险等级**：中

**注意事项**：修改权限后可能导致原所有者无法访问文件，需提前确认权限分配合理性；递归修改系统目录所有者可能导致系统异常，严禁随意操作。

**依赖条件**：无，需root权限或文件所有者

#### 指令3：umask

- **功能**：查看/设置默认文件权限，默认权限=最大权限（文件666、目录777）-umask值

- **参数**：无核心参数，直接指定数值则设置，无参数则查看

- **实操示例**：
    `umask  # 查看当前默认umask值（默认0022）
umask 002  # 临时设置umask为002，文件默认664、目录775
` `echo "umask 002" >> ~/.bashrc  # 永久设置当前用户umask（重启生效）`

- **风险等级**：低

- **注意事项**：临时设置仅对当前终端生效，永久设置需写入用户环境变量文件（~/.bashrc）或系统全局文件（/etc/profile）；umask值越小，默认权限越宽松，需结合安全需求配置。

- **依赖条件**：无

#### 指令4：getfacl

- **功能**：查看文件/目录的ACL（访问控制列表）权限，支持精细化授权

- **参数**：无核心参数，指定文件/目录即可查看

- **实操示例**：
    `sudo apt install acl  # 安装acl工具包
getfacl test.txt  # 查看文件ACL权限
` `getfacl /data/dev  # 查看目录ACL权限`

- **风险等级**：低

- **注意事项**：纯信息查看指令，ACL权限可实现超越传统所有者/组/其他的精细化授权，需先安装acl工具包才能使用。

- **依赖条件**：需安装acl工具包（apt install acl）

#### 指令5：setfacl

- **功能**：设置文件/目录的ACL（访问控制列表）权限，实现精细化用户/组授权，突破传统权限限制

- **参数**：
    -m u:用户名:权限：给指定用户设置ACL权限

- -m g:组名:权限：给指定组设置ACL权限

- -R：递归设置目录及子内容ACL权限

- -x u:用户名：删除指定用户的ACL权限

- **实操示例**：
    `sudo setfacl -m u:testuser:rwx test.txt  # 给testuser设置文件读写执行权限
sudo setfacl -m g:devgroup:rx /data/dev  # 给devgroup设置目录读执行权限
sudo setfacl -R -m u:guest:r /data/logs  # 递归给guest设置目录读权限
` `sudo setfacl -x u:guest test.txt  # 删除guest用户的ACL权限`

- **风险等级**：中

- **注意事项**：ACL权限优先级高于传统权限，设置后需通过getfacl验证；递归设置时避免给敏感文件开放过多权限，删除ACL权限需使用setfacl -b指令；挂载文件系统时需确保支持ACL（ext4、xfs默认支持）。

- **依赖条件**：需安装acl工具包（apt install acl）

**实操示例**：
    `sudo setfacl -m u:testuser:rwx test.txt  # 给testuser设置文件读写执行权限
sudo setfacl -m g:devgroup:rx /data/dev  # 给devgroup设置目录读执行权限
` `sudo setfacl -R -m u:guest:r /data/logs  # 递归给guest设置目录读权限`

**风险等级**：中

**注意事项**：ACL权限优先级高于传统权限，设置后需通过getfacl验证；递归设置时避免给敏感文件开放过多权限，删除ACL权限需使用setfacl -b指令。

**依赖条件**：需安装acl工具包（apt install acl）

#### 指令6：setfacl -b（冷门实用）

- **功能**：清除文件/目录的所有ACL权限，恢复默认传统权限控制

- **参数**：-R：递归清除目录及子内容的ACL权限

- **实操示例**：`sudo setfacl -b test.txt  # 清除单个文件ACL权限
` `sudo setfacl -R -b /data/dev  # 递归清除目录及子内容ACL权限`

- **风险等级**：中

- **注意事项**：清除ACL权限后，文件/目录仅受传统所有者/组/其他权限控制，需确认是否影响业务授权，操作前建议备份ACL配置（getfacl > acl_backup.txt）。

- **依赖条件**：需安装acl工具包（apt install acl）

# 04-进程管理.md

![License: MIT](https://img.shields.io/badge/License-MIT-yellow.svg)

## 📌 章节简介

涵盖Ubuntu 24.04 LTS系统进程查看、筛选、启停、优先级调整及状态监控指令，适用于进程异常排查、资源占用分析、服务启停管控等核心运维场景，是保障系统稳定运行的关键模块。

## 🔧 核心指令清单

|指令|核心功能|风险等级|依赖条件|
|---|---|---|---|
|ps|查看进程静态信息|低|无，默认预装|
|top|实时监控进程动态及资源占用|低|无，默认预装|
|htop（冷门实用）|增强型实时进程监控，界面更友好|低|需安装htop工具包|
|pkill|根据进程名终止进程|高危|无，默认预装|
|kill|根据PID终止进程，支持信号控制|高危|无，默认预装|
|killall|根据进程名终止所有匹配进程|高危|无，默认预装|
|nice|调整新启动进程的优先级|中|无，默认预装|
|renice|调整已运行进程的优先级|中|无，默认预装|
|pgrep（冷门实用）|根据进程名、用户筛选PID|低|无，默认预装|
|nohup|后台运行进程，不受终端关闭影响|低|无，默认预装|
|jobs|查看当前终端后台运行的进程|低|无，默认预装|
## 📋 详细操作指南

### 进程查看与监控

#### 指令1：ps

- **功能**：查看进程静态快照信息，可筛选进程状态、归属用户等

- **参数**：aux：显示所有用户（a）、无终端关联（x）、详细信息（u）的进程

- -ef：显示进程PID、父PID、命令行等完整信息，适合追溯进程关系

- -p PID：仅查看指定PID的进程

**实操示例**：
    `ps aux  # 查看系统所有进程详细信息
ps -ef | grep nginx  # 筛选nginx相关进程
ps -p 1234  # 查看PID为1234的进程状态
` `ps aux --sort=-%cpu  # 按CPU占用率降序排列进程`

**风险等级**：低

**注意事项**：静态快照仅反映执行瞬间的进程状态，需结合top实时监控排查动态问题；筛选进程时建议用grep精准匹配，避免误判。

**依赖条件**：无，Ubuntu 24.04默认预装

#### 指令2：top

- **功能**：实时刷新进程列表，展示CPU、内存、负载等资源占用，默认每3秒刷新一次

- **核心操作**：
    P：按CPU占用率降序排序

- M：按内存占用率降序排序

- k：输入PID并发送信号终止进程

- q：退出top界面

**实操示例**：
   `top  # 启动实时进程监控
top -p 1234  # 仅监控PID为1234的进程
` `top -d 5  # 设置刷新间隔为5秒`

**风险等级**：低

**注意事项**：top自身占用少量系统资源，对高负载服务器无明显影响；通过top可快速定位资源占用过高的进程，为故障排查提供依据。

**依赖条件**：无，Ubuntu 24.04默认预装

#### 指令3：htop（冷门实用）

- **功能**：top增强版，支持鼠标操作、彩色界面、进程树展示，更易读

- **核心操作**：
    F9：发送信号终止进程，界面化选择信号类型

- F5：展示进程树，清晰查看父进程与子进程关系

- F6：选择排序字段（CPU、内存、PID等）

**实操示例**：
`sudo apt install htop  # 安装htop工具
htop  # 启动增强型进程监控
` `htop -u testuser  # 仅监控testuser用户的进程`

**风险等级**：低

**注意事项**：界面操作友好，适合运维人员快速排查进程问题，功能与top兼容，可作为top的替代工具。

**依赖条件**：需安装htop工具包（apt install htop）

#### 指令4：pgrep（冷门实用）

- **功能**：精准筛选进程PID，支持按进程名、用户、终端等条件过滤，无需结合grep

- **参数**：
    -u 用户名：筛选指定用户的进程PID

- -l：同时显示PID和进程名

- -f：按进程完整命令行筛选

**实操示例**：
`pgrep nginx  # 筛选nginx进程的PID
pgrep -u testuser -l  # 显示testuser用户进程的PID和名称
` `pgrep -f "python app.py"  # 按完整命令行筛选进程PID`

**风险等级**：低

**注意事项**：筛选结果仅为PID（或PID+名称），适合作为kill、renice等指令的输入，简化运维操作。

**依赖条件**：无，Ubuntu 24.04默认预装

### 进程启停与控制

#### 指令1：kill

- **功能**：向指定PID的进程发送信号，实现进程终止、重启等控制，默认发送15号终止信号（SIGTERM）

- **常用信号**：
    15（SIGTERM）：优雅终止进程，允许进程保存数据（默认）

- 9（SIGKILL）：强制终止进程，不允许保存数据，无响应时使用

- 1（SIGHUP）：重启进程，常用于服务配置生效

**实操示例**：
    `kill 1234  # 发送15号信号，优雅终止PID=1234的进程
kill -9 1234  # 发送9号信号，强制终止进程
kill -1 5678  # 发送1号信号，重启PID=5678的进程
` `kill -l  # 列出所有支持的信号类型`

**风险等级**：高危

**注意事项**：强制终止进程（-9）可能导致数据丢失或资源泄漏，优先使用默认15号信号；终止系统核心进程（如PID=1）会导致系统崩溃，严禁操作。

**依赖条件**：无，默认预装；普通用户仅可终止自身进程，root可终止所有进程

#### 指令2：pkill

- **功能**：按进程名筛选并发送信号，无需手动查询PID，简化批量进程终止操作

- **参数**：
    -9：强制终止匹配进程（等同于kill -9）

- -u 用户名：仅终止指定用户的匹配进程

- -f：按完整命令行匹配进程名

**实操示例**：
   `pkill nginx  # 优雅终止所有nginx进程
pkill -9 python  # 强制终止所有python进程
pkill -u testuser node  # 终止testuser用户的所有node进程
` `pkill -f "java -jar app.jar"  # 按完整命令行终止目标进程`

**风险等级**：高危

**注意事项**：进程名匹配可能存在歧义（如“java”进程可能对应多个服务），建议先用pgrep验证匹配结果，再执行终止操作；避免批量强制终止进程影响系统稳定性。

**依赖条件**：无，默认预装

#### 指令3：killall

- **功能**：与pkill类似，按进程名终止所有匹配进程，支持通配符匹配

- **参数**：
    -9：强制终止进程

- -r：使用正则表达式匹配进程名

**实操示例**：`killall nginx  # 优雅终止所有nginx进程
killall -9 java  # 强制终止所有java进程
` `killall -r "node.*"  # 用正则终止所有以node开头的进程`

**风险等级**：高危

**注意事项**：通配符和正则匹配需精准，避免误杀无关进程；与pkill相比，killall更适合简单进程名匹配，复杂场景建议用pkill -f。

**依赖条件**：无，默认预装

### 进程优先级调整与后台运行

#### 指令1：nice

- **功能**：设置新启动进程的优先级，优先级范围为-20（最高）~19（最低），默认优先级为0

- **参数**：直接指定优先级数值，负值需root权限

- **实操示例**：
    `nice -n 5 python app.py  # 以优先级5启动进程
sudo nice -n -10 ./server  # 以高优先级（-10）启动进程（需root）
` `nice --adjustment=3 ./script.sh  # 调整优先级为默认+3`

- **风险等级**：中

- **注意事项**：高优先级（负值）进程会抢占更多CPU资源，避免给非核心进程设置过高优先级，导致系统资源分配失衡；普通用户仅可设置0~19的优先级。

- **依赖条件**：无，默认预装

#### 指令2：renice

- **功能**：调整已运行进程的优先级，支持按PID、用户、组批量调整

- **参数**：
    -n 优先级：指定目标优先级

- -u 用户名：调整指定用户所有进程的优先级

- -g 组名：调整指定组所有进程的优先级

**实操示例**：
    `sudo renice -n 8 1234  # 将PID=1234的进程优先级调整为8
sudo renice -n -5 -u testuser  # 调整testuser用户所有进程优先级为-5
` `sudo renice -n 10 -g devgroup  # 调整devgroup组所有进程优先级为10`

**风险等级**：中

**注意事项**：调整正在运行的核心服务优先级时，需确认不影响业务运行；批量调整用户/组进程优先级可能导致多个服务性能变化，需谨慎操作。

**依赖条件**：无，默认预装；调整其他用户进程需root权限

#### 指令3：nohup

- **功能**：让进程在后台运行，不受终端关闭（HUP信号）影响，输出默认重定向到nohup.out文件

- **参数**：无核心参数，需配合&实现后台运行

- **实操示例**：
    `nohup python app.py &  # 后台运行进程，输出到nohup.out
nohup ./server > server.log 2>&1 &  # 重定向输出到server.log，后台运行
` `nohup --help  # 查看nohup使用说明`

- **风险等级**：低

- **注意事项**：后台运行进程需通过ps/pgrep查询PID，再用kill终止；输出文件会持续增长，需定期清理或设置日志轮转。

- **依赖条件**：无，默认预装

#### 指令4：jobs

- **功能**：查看当前终端后台运行的进程（仅对当前终端有效，nohup进程需用ps查看）

- **参数**：
    -l：同时显示进程PID

- -r：仅显示正在运行的后台进程

**实操示例**：
    `jobs  # 查看当前终端后台进程
jobs -l  # 显示后台进程及PID
jobs -r  # 仅显示运行中的后台进程
fg %1  # 将编号为1的后台进程调至前台运行
` `bg %2  # 将编号为2的暂停进程恢复为后台运行`

**风险等级**：低

**注意事项**：终端关闭后，jobs记录会丢失；进程编号（%1、%2）仅对当前终端有效，重启终端后失效。

**依赖条件**：无，默认预装

# 05-系统监控与性能分析.md

![License: MIT](https://img.shields.io/badge/License-MIT-yellow.svg)

## 📌 章节简介

涵盖Ubuntu 24.04 LTS系统CPU、内存、磁盘IO、网络IO及系统负载的监控与性能分析指令，适用于系统性能瓶颈排查、资源占用异常告警、长期性能趋势分析等运维场景，为系统优化提供数据支撑。

## 🔧 核心指令清单

|指令|核心功能|风险等级|依赖条件|
|---|---|---|---|
|vmstat|监控系统CPU、内存、磁盘IO整体状态|低|无，默认预装|
|iostat|监控磁盘IO性能及CPU负载关联|低|需安装sysstat工具包|
|sar|收集并分析系统资源历史与实时数据|低|需安装sysstat工具包|
|free|查看系统内存使用情况|低|无，默认预装|
|df|查看磁盘分区容量使用情况|低|无，默认预装|
|du|查看文件/目录占用磁盘空间大小|低|无，默认预装|
|iftop（冷门实用）|实时监控网络带宽占用，按连接排序|低|需安装iftop工具包|
|nmon（冷门实用）|综合监控CPU、内存、磁盘、网络，界面化展示|低|需安装nmon工具包|
|mpstat|监控多CPU核心各自负载情况|低|需安装sysstat工具包|
## 📋 详细操作指南

### CPU与内存监控

#### 指令1：vmstat

- **功能**：综合监控系统CPU、内存、交换分区、磁盘IO整体状态，输出指标简洁直观，适合快速定位系统整体性能瓶颈，为后续精准排查提供方向。

- **参数**：
   间隔时间 次数：如vmstat 2 5（每2秒输出1次，共5次，无次数则持续输出）；

- -s：按内存维度输出统计汇总信息，含物理内存、交换分区读写总量等；

- -d：单独展示磁盘IO统计详情，区分各磁盘设备的读写状态；

- -S 单位：指定内存显示单位（k/K/m/M/g/G），如vmstat -S m（以MB为单位）。

- **实操示例**：
    `vmstat 2 5  # 每2秒输出1次系统整体状态，共输出5次
vmstat -s  # 查看内存相关统计信息汇总
vmstat -d  # 单独查看磁盘IO统计详情
` `vmstat -S m 2 3  # 以MB为单位，每2秒输出1次，共3次`

- **风险等级**：低

- **注意事项**：核心关注指标包括r（等待CPU调度的进程数，长期大于CPU核心数需排查CPU瓶颈）、si/so（交换分区读写量，频繁非零说明物理内存不足，需优化内存或扩容）、bi/bo（块设备读写量，单位块/秒，过高需结合iostat定位具体磁盘）；输出为系统全局状态，无法定位单个进程，需搭配ps、top等工具精准溯源。

- **依赖条件**：无，Ubuntu 24.04默认预装。

#### 指令2：iostat

- **功能**：专项监控磁盘IO性能，同时关联展示CPU负载情况，支持区分单个磁盘设备指标，可精准定位磁盘IO瓶颈，排查磁盘响应缓慢、使用率过高问题。

- **参数**：
                  -d：仅显示磁盘IO统计信息，屏蔽CPU负载输出；

- -x：显示扩展IO指标，含磁盘使用率、读写响应时间、队列长度等核心指标；

- -c：仅显示CPU负载统计，屏蔽磁盘IO输出；

- 间隔时间 次数：实时循环输出，无次数则持续刷新；

- 设备名：指定监控单个/多个磁盘，如iostat sda sdb（仅监控sda、sdb磁盘）。

- **实操示例**：
                  `sudo apt install sysstat  # 安装sysstat工具包（含iostat）
iostat -x 2 3  # 每2秒输出1次扩展IO指标，共3次，含CPU和磁盘信息
iostat -d sda 5  # 仅监控sda磁盘IO，每5秒输出1次，持续运行
iostat -c 1 10  # 仅监控CPU负载，每1秒输出1次，共10次
` `iostat -xd 3 sda sdb  # 每3秒输出sda、sdb磁盘扩展IO指标，持续运行`

- **风险等级**：低

- **注意事项**：核心关注指标：%util（磁盘使用率，长期超过80%说明磁盘IO饱和，存在瓶颈）、r_await/w_await（读写响应时间，单位毫秒，通常应低于50ms，过高可能是磁盘故障或读写请求过量）、avgqu-sz（IO队列长度，长期大于2需排查读写优化）；首次执行可能因系统未收集统计数据导致结果为空，等待1-2秒重新执行即可。

- **依赖条件**：需安装sysstat工具包，安装命令：sudo apt install sysstat。

#### 指令3：sar

- **功能**：集实时监控与历史数据统计于一体，支持CPU、内存、磁盘、网络等多维度资源分析，可生成性能趋势报告，既能实时排查故障，也能复盘历史性能问题，适合长期性能监控与优化。

- **参数**：
                  -u：监控CPU负载及使用率（用户态、内核态、空闲态等）；

- -r：监控物理内存与交换分区使用情况；

- -d：监控磁盘IO性能，支持指定磁盘设备；

- -n DEV：监控网络接口收发速率、丢包率等指标；

- -o 文件名：将统计数据保存到文件，用于后续复盘；

- -f 文件名：读取已保存的历史统计文件，分析过往性能数据；

- 间隔时间 次数：实时循环输出，无次数则持续运行。

- **实操示例**：
                  `sar -u 2 5  # 每2秒输出1次CPU负载，共5次
sar -r -o mem_stats 3 10  # 每3秒记录1次内存状态，共10次，保存到mem_stats文件
sar -f mem_stats  # 读取历史内存统计文件，复盘性能数据
sar -d 1 5 sda  # 监控sda磁盘IO，每1秒输出1次，共5次
sar -n DEV 2 3  # 每2秒输出1次网络接口收发情况，共3次
` `sar -u -r 5  # 每5秒同时输出CPU和内存状态，持续运行`

- **风险等级**：低

- **注意事项**：系统默认周期性保存sar日志（路径/var/log/sa/，文件名为saXX，XX为日期），可通过sar -f /var/log/sa/saXX复盘对应日期性能；保存的数据文件占用空间小（单文件几十KB），可长期开启用于故障回溯；监控网络时需指定-n DEV，否则不输出网络指标。

- **依赖条件**：需安装sysstat工具包，安装命令：sudo apt install sysstat。

#### 指令4：free

- **功能**：快速查看系统物理内存与交换分区（Swap）的使用、空闲、缓存等状态，输出简洁直观，适合快速判断内存是否充足、缓存占用是否合理，排查内存不足问题。

- **参数**：
                  -h：以人类可读格式显示（自动适配KB/MB/GB单位），便于查看；

- -m：固定以MB为单位显示内存数据；

- -g：固定以GB为单位显示内存数据；

- -s 间隔时间：循环输出内存状态，每间隔指定时间刷新1次，按Ctrl+C终止；

- -t：显示内存总容量、已用、空闲等汇总信息，含物理内存和交换分区。

- **实操示例**：
                  `free -h  # 人性化格式显示内存与交换分区使用情况
free -m -s 2  # 以MB为单位，每2秒输出1次内存状态，持续运行
free -g  # 以GB为单位显示内存数据
free -t  # 显示内存与交换分区汇总信息
` `free -hm  # 人性化格式+MB单位辅助显示，精准查看数值`

- **风险等级**：低

- **注意事项**：Linux系统会将空闲内存用于文件缓存（buff/cache字段），此部分内存可动态回收，实际可用内存需重点关注available字段（而非free字段）；交换分区（Swap）使用率长期超过30%，说明物理内存紧张，需优化内存配置、关闭无用服务或增加物理内存，避免频繁换页导致系统卡顿。

- **依赖条件**：无，Ubuntu 24.04默认预装。

### 磁盘容量与空间监控

#### 指令1：df

- **功能**：查看磁盘各分区的容量使用情况，包括总容量、已用容量、空闲容量、使用率及挂载点，可快速排查磁盘满溢、分区使用率过高问题，明确各分区存储压力。

- **参数**：
                 -h：以人类可读格式显示容量（KB/MB/GB），便于直观查看；

- -T：显示分区文件系统类型（如ext4、xfs、tmpfs等）；

- -i：查看分区inode使用情况（而非容量），排查inode满导致无法创建文件问题；

- -P：显示分区对应的物理设备名，明确分区与磁盘的关联；

- 挂载点/设备名：指定查看单个分区的容量情况，如df -h /data（仅查看/data分区）。

- **实操示例**：
                  `df -h  # 人性化显示所有分区容量使用情况及挂载点
df -hT /data  # 查看/data分区容量、使用率及文件系统类型
df -i  # 查看各分区inode使用情况，避免inode满导致无法创建文件
df -hP /dev/sda1  # 查看sda1分区容量，显示物理设备名
` `df -h | grep -v tmpfs  # 过滤tmpfs临时分区，仅显示实际磁盘分区`

- **风险等级**：低

- **注意事项**：分区使用率（Use%）超过90%需及时清理无用文件（日志、临时文件、冗余备份）；/boot分区通常容量较小，易因系统更新包堆积满溢，需定期清理旧内核；inode满时，即使磁盘有空闲容量也无法创建文件，需删除大量小文件（如日志碎片）释放inode。

- **依赖条件**：无，Ubuntu 24.04默认预装。

#### 指令2：du

- **功能**：统计单个文件或目录占用的磁盘空间大小，支持递归统计子目录，可精准定位大文件、大目录，排查磁盘空间被异常占用的根源，辅助空间清理。

- **参数**：
-h：以人类可读格式显示大小（KB/MB/GB）；

- -r：递归统计目录及所有子目录、文件的大小；

- -s：仅显示目录总大小，不列出子目录和文件明细；

- --max-depth=N：限制递归深度为N级，如--max-depth=2（仅统计目录及一级子目录）；

- -a：统计所有文件（含隐藏文件）的大小，默认仅统计目录和非隐藏文件。

- **实操示例**：
                  `du -sh /data  # 仅显示/data目录总占用空间，不列出子项
du -rh --max-depth=2 /home  # 递归显示/home下2级目录大小，人性化格式，含隐藏文件
du -h test.log  # 查看单个文件大小
du -rh /var | sort -hr | head -10  # 排序并显示/var下占用空间前10的目录/文件
` `du -ah --max-depth=1 /root  # 显示/root目录下所有文件（含隐藏）及一级子目录大小`

- **风险等级**：低

- **注意事项**：递归统计超大目录（如/）时耗时较长，建议搭配--max-depth限制范围，或指定具体目录；du与df结果可能存在差异（df统计分区整体容量，含inode、预留空间；du统计文件实际占用），若差异过大，需排查已删除但进程仍占用的文件（通过lsof | grep deleted清理）。

- **依赖条件**：无，Ubuntu 24.04默认预装。

### 网络监控与综合监控

#### 指令1：iftop（冷门实用）

- **功能**：实时监控网络带宽占用情况，按连接或主机排序，直观展示各网络连接的收发速率、总流量，可快速定位带宽占用异常的IP、端口及服务，排查网络瓶颈。

- **参数**：
                  -i 网卡名：指定监控的网卡（如eth0、ens33、wlan0），不指定则监控所有网卡；

- -n：不解析主机名和端口名（加速界面刷新，避免DNS解析延迟）；

- -P：显示端口号，明确带宽占用对应的服务（如80端口对应HTTP服务）；

- -B：以字节（B）为单位显示带宽（默认以比特bit为单位）；

- -F 配置文件：加载自定义配置文件，自定义监控规则。

- **实操示例**：
                  `sudo apt install iftop  # 安装iftop工具包
iftop -i ens33  # 监控ens33网卡的带宽占用情况，实时刷新
iftop -nP  # 不解析主机名，显示端口号，快速定位占用带宽的服务
iftop -B -i eth0  # 以字节为单位，监控eth0网卡带宽
` `iftop -nP -i ens33 | grep 8080  # 过滤8080端口，监控对应服务带宽占用`

- **风险等级**：低

- **注意事项**：界面默认按带宽占用降序排列，实时刷新（默认2秒/次），按q键退出；监控多网卡服务器时需指定网卡，避免整体带宽统计混淆；显示的速率为实时波动值，需观察30秒以上判断是否为持续性异常占用；高带宽场景下，-n参数可显著提升界面流畅度。

- **依赖条件**：需安装iftop工具包，安装命令：sudo apt install iftop。

#### 指令2：nmon（冷门实用）

- **功能**：综合型可视化监控工具，界面化展示CPU、内存、磁盘、网络、进程等多维度指标，支持鼠标操作和快捷键切换，适合运维人员快速巡检、全面掌握系统性能状态。

- **核心操作与参数**：
                 **快捷键**：c（单独显示CPU指标，含各核心使用率）、m（单独显示内存/交换分区）、d（单独显示磁盘IO）、n（单独显示网络收发）、p（显示进程列表）、q（退出nmon）、s 间隔时间（设置刷新间隔，单位秒）；

- **参数**：-s 间隔时间：启动时指定刷新间隔；-c 次数：指定刷新次数后自动退出；-f：生成日志文件；-m 目录：指定日志文件保存目录。

- **实操示例**：
                  `sudo apt install nmon  # 安装nmon工具包
nmon  # 启动综合监控界面，默认每2秒刷新1次
nmon -s 2 -c 10 -f -m /tmp  # 每2秒刷新1次，共10次，生成日志文件保存到/tmp目录
nmon -s 5  # 启动监控，设置刷新间隔为5秒
` `# 界面操作：启动后按c/m/d/n切换单维度指标，按q退出`

- **风险等级**：低

- **注意事项**：界面操作友好，支持鼠标点击切换指标，适合新手运维使用；生成的日志文件格式为.csv，可导出到Excel分析性能趋势；对系统资源占用极低（CPU使用率<1%），可长期后台运行用于持续监控；支持多平台适配，风格统一，无需额外学习成本。

- **依赖条件**：需安装nmon工具包，安装命令：sudo apt install nmon。

#### 指令3：mpstat

- **功能**：专项监控多CPU核心各自的负载情况，可区分单个核心的使用率、空闲率，精准定位CPU核心负载不均衡问题，排查单核心饱和、其他核心空闲的场景。

- **参数**：
                  -P ALL：显示所有CPU核心及整体负载情况（默认选项）；

- -P 核心编号：仅显示指定CPU核心的负载（核心编号从0开始，如-P 0表示第一个核心）；

- -u：以百分比显示CPU使用率（默认）；

- 间隔时间 次数：实时循环输出，无次数则持续刷新，按Ctrl+C终止。

- **实操示例**：
                  `mpstat 2 3  # 每2秒输出1次所有CPU核心及整体负载，共3次
mpstat -P 0 1 5  # 仅监控CPU核心0，每1秒输出1次，共5次
mpstat -P ALL 5  # 每5秒输出1次所有CPU核心负载，持续运行
mpstat -P 1,3 2 4  # 仅监控核心1和核心3，每2秒输出1次，共4次
` `mpstat 1 10 | grep -E "CPU|all"  # 过滤仅显示整体CPU负载，每1秒输出1次，共10次`

- **风险等级**：低

- **注意事项**：核心关注指标：%usr（用户态进程占用率）、%sys（内核态进程占用率）、%idle（空闲率）；若单个核心%idle长期低于10%，而其他核心空闲，需排查对应进程的CPU亲和性配置（是否绑定了特定核心），或优化进程并发逻辑；CPU核心编号可通过lscpu命令查看，确认核心总数及编号范围。

- **依赖条件**：需安装sysstat工具包，安装命令：sudo apt install sysstat。

# 06-网络管理.md

![License: MIT](https://img.shields.io/badge/License-MIT-yellow.svg)

## 📌 章节简介

涵盖Ubuntu 24.04 LTS系统网卡配置、网络连通性测试、端口监控、路由管理及防火墙配置等核心指令，适用于网络故障排查、网络参数调整、访问权限管控等运维场景，是保障系统网络通畅与安全的核心模块。

## 🔧 核心指令清单

|指令|核心功能|风险等级|依赖条件|
|---|---|---|---|
|ip|网卡配置、路由管理、ARP缓存操作（替代ifconfig）|中|无，默认预装|
|ping|测试网络连通性，发送ICMP请求包|低|无，默认预装|
|netstat|查看网络连接、端口监听、路由表（兼容旧系统）|低|需安装net-tools工具包|
|ss|查看网络连接、端口监听，效率优于netstat|低|无，默认预装|
|ufw|Ubuntu默认防火墙，配置端口访问权限|中|无，默认预装，需root权限|
|dhclient|从DHCP服务器获取动态IP地址|低|无，默认预装|
|route|查看/添加/删除静态路由（逐步被ip route替代）|中|无，默认预装|
|nmap（冷门实用）|端口扫描、主机探测、网络拓扑分析|中|需安装nmap工具包|
|traceroute（冷门实用）|追踪数据包传输路径，定位网络中断节点|低|需安装traceroute工具包|
|arp|查看/清除ARP缓存表，绑定IP与MAC地址|中|无，默认预装|
## 📋 详细操作指南

### 网卡配置与状态查看

#### 指令1：ip

- **功能**：Ubuntu 24.04推荐的网络管理工具，集成网卡配置、路由管理、ARP缓存、网络命名空间等功能，全面替代传统ifconfig、route指令。

- **核心子命令与参数**：addr：网卡IP地址管理（查看、添加、删除），参数add（添加IP）、del（删除IP）、show（查看）；

- link：网卡状态管理，参数set（设置状态）、show（查看），up/down控制网卡启用/禁用；

- route：路由表管理，参数add（添加路由）、del（删除路由）、show（查看）；

- neigh：ARP缓存管理，参数show（查看）、flush（清除）。

**实操示例**：
    `ip addr show  # 查看所有网卡IP地址及状态
ip addr add 192.168.1.100/24 dev ens33  # 给ens33网卡添加临时静态IP
ip addr del 192.168.1.100/24 dev ens33  # 删除ens33网卡指定IP
ip link set ens33 up  # 启用ens33网卡
ip link set ens33 down  # 禁用ens33网卡
ip route show  # 查看系统路由表
ip route add default via 192.168.1.1 dev ens33  # 添加默认网关
ip neigh show  # 查看ARP缓存表
` `ip neigh flush dev ens33  # 清除ens33网卡ARP缓存`

**风险等级**：中

**注意事项**：通过ip指令添加的IP、路由均为临时配置，重启网络服务或系统后失效；若需永久生效，需编辑/etc/netplan/目录下的YAML配置文件（Ubuntu 24.04默认使用netplan）；禁用网卡前需确认不影响远程连接，避免断连。

**依赖条件**：无，Ubuntu 24.04默认预装iproute2工具包（含ip指令）。

#### 指令2：dhclient

- **功能**：向DHCP服务器发送请求，自动获取IP地址、子网掩码、网关、DNS等网络参数，适用于动态IP场景。

- **参数**：
    -r：释放已获取的DHCP IP地址；

- -v： verbose模式，显示获取IP的详细过程；

- 网卡名：指定仅给某块网卡获取IP（如dhclient ens33）。

**实操示例**：
    `dhclient ens33  # 给ens33网卡获取动态IP
dhclient -r ens33  # 释放ens33网卡的DHCP IP
` `dhclient -v ens33  # 详细模式获取IP，查看协商过程`

**风险等级**：低

**注意事项**：执行dhclient后会覆盖网卡原有静态IP；若DHCP服务器无响应，网卡可能无法获取IP，需检查网络链路或DHCP服务状态。

**依赖条件**：无，Ubuntu 24.04默认预装isc-dhcp-client包（含dhclient）。

### 网络连通性与路由测试

#### 指令1：ping

- **功能**：通过发送ICMP Echo Request数据包，测试目标主机的网络连通性，判断链路是否通畅。

- **参数**：
    -c 次数：指定发送数据包次数，避免持续发送（如ping -c 4 8.8.8.8）；

- -i 间隔：指定数据包发送间隔（单位秒，默认1秒）；

- -s 大小：指定数据包大小（单位字节，默认64字节）；

- -W 超时：指定等待响应的超时时间（单位秒）。

**实操示例**：
    `ping -c 4 8.8.8.8  # 向谷歌DNS发送4个数据包，测试外网连通性
ping -i 2 -c 5 192.168.1.1  # 每2秒发送1个包，共5次，测试网关连通性
` `ping -W 3 www.baidu.com  # 测试百度域名连通性，超时时间3秒`

**风险等级**：低

**注意事项**：部分服务器会禁用ICMP协议，导致ping不通但服务正常（需通过端口测试验证）；持续ping可能占用网络带宽，生产环境建议指定-c参数限制次数。

**依赖条件**：无，默认预装iputils-ping包（含ping）。

#### 指令2：traceroute（冷门实用）

- **功能**：追踪数据包从本地到目标主机的传输路径，显示每一跳路由节点的IP和响应时间，可精准定位网络中断或延迟过高的节点。

- **参数**：
    -n：不解析主机名，仅显示IP（加速输出，避免DNS解析延迟）；

- -m 跳数：指定最大追踪跳数（默认30跳）；

- -w 超时：指定每一跳的响应超时时间（单位秒）。

**实操示例**：
    `sudo apt install traceroute  # 安装traceroute工具包
traceroute -n www.aliyun.com  # 追踪到阿里云的路径，仅显示IP
` `traceroute -m 20 -w 2 192.168.2.1  # 最大20跳，超时2秒，追踪内网主机路径`

**风险等级**：低

**注意事项**：部分路由节点会禁止响应traceroute数据包，显示为“*”，属正常现象；可结合ping指令，判断是路由故障还是目标主机故障。

**依赖条件**：需安装traceroute工具包，安装命令：sudo apt install -y traceroute。

#### 指令3：route

- **功能**：查看、添加、删除系统静态路由，适用于多网段访问场景，逐步被ip route指令替代，仅用于兼容旧操作习惯。

- **参数**：
    -n：不解析主机名，仅显示IP和子网掩码；

- add：添加静态路由，需指定目标网段、网关、网卡；

- del：删除静态路由，指定目标网段即可。

**实操示例**：
    `route -n  # 查看路由表，不解析主机名
route add -net 192.168.3.0/24 gw 192.168.1.1 dev ens33  # 添加静态路由（访问192.168.3.0网段走网关192.168.1.1）
` `route del -net 192.168.3.0/24  # 删除指定静态路由`

**风险等级**：中

**注意事项**：通过route指令添加的路由为临时配置，重启系统后失效；错误的路由配置可能导致网络不通，建议添加前备份路由表（route -n > route_backup.txt）。

**依赖条件**：无，默认预装net-tools工具包（含route）。

### 端口与网络连接监控

#### 指令1：ss

- **功能**：查看系统网络连接状态、端口监听情况、进程与端口关联，底层基于netlink机制，效率远高于netstat，是Ubuntu 24.04推荐工具。

- **参数**：
-t：仅显示TCP连接；

- -u：仅显示UDP连接；

- -l：仅显示监听状态的端口；

- -p：显示端口对应的进程名和PID；

- -n：不解析主机名和端口名（如80端口不显示http）；

- -a：显示所有网络连接（监听+非监听）。

**实操示例**：
    `ss -tlnp  # 查看所有监听状态的TCP端口，显示进程信息，不解析名称
ss -uan  # 查看所有UDP连接，不解析名称
ss -ap | grep nginx  # 查看与nginx进程相关的所有网络连接
` `ss -tln | grep :80  # 检查80端口是否处于监听状态`

**风险等级**：低

**注意事项**：需root权限才能显示所有进程的关联信息（普通用户仅能查看自身进程）；结合grep可快速过滤目标端口或进程的连接状态。

**依赖条件**：无，Ubuntu 24.04默认预装iproute2工具包（含ss）。

#### 指令2：netstat

- **功能**：传统网络连接监控工具，功能与ss类似，兼容性强，适用于习惯旧指令的场景，效率低于ss。

- **参数**：与ss基本一致，常用-tlnp、-uan、-ap等组合参数。

- **实操示例**：
    `sudo apt install net-tools  # 安装net-tools工具包（含netstat）
netstat -tlnp  # 查看监听的TCP端口及对应进程
netstat -uan  # 查看所有UDP连接
` `netstat -ap | grep 3306  # 查看3306端口相关的网络连接`

- **风险等级**：低

- **注意事项**：Ubuntu 24.04默认不安装net-tools，需手动安装；建议优先使用ss指令，仅在兼容旧脚本时使用netstat。

- **依赖条件**：需安装net-tools工具包，安装命令：sudo apt install -y net-tools。

### 防火墙管理（ufw）

#### 指令：ufw

- **功能**：Ubuntu默认的简易防火墙工具，基于iptables封装，可快速配置端口允许/拒绝访问、设置默认策略，适用于基础网络安全管控。

- **核心参数与命令**：
enable/disable：开启/关闭ufw防火墙；

- status：查看防火墙运行状态及规则列表；

- allow 端口/服务：允许指定端口或服务的访问（如allow 80、allow ssh）；

- deny 端口/服务：拒绝指定端口或服务的访问；

- delete 规则：删除已配置的防火墙规则（如delete allow 80）；

- default 策略：设置默认入站/出站策略（如default deny incoming，默认拒绝所有入站连接）。

**实操示例**：
`sudo ufw enable  # 开启ufw防火墙，开机自启
sudo ufw disable  # 关闭ufw防火墙
sudo ufw status verbose  # 查看防火墙状态及详细规则
sudo ufw allow 80/tcp  # 允许TCP 80端口访问
sudo ufw allow ssh  # 允许SSH服务（22端口）访问
sudo ufw deny 3306  # 拒绝所有3306端口访问
sudo ufw delete allow 80  # 删除允许80端口的规则
sudo ufw default deny incoming  # 设置默认拒绝入站连接
` `sudo ufw default allow outgoing  # 设置默认允许出站连接`

**风险等级**：中

**注意事项**：开启防火墙前需确保允许SSH端口（22）访问，避免远程连接中断；规则配置后立即生效，无需重启防火墙；复杂防火墙需求（如端口转发、IP段限制）需直接配置iptables。

**依赖条件**：无，Ubuntu 24.04默认预装ufw，所有操作需root权限。

### 冷门实用工具

#### 指令1：nmap

- **功能**：强大的网络扫描工具，支持端口扫描、主机存活探测、操作系统识别、服务版本探测等，适用于网络安全巡检、端口开放情况排查。

- **常用参数**：
    -p 端口范围：指定扫描的端口（如-p 1-1000、-p 80,443）；

- -sS：半开放扫描（SYN扫描），效率高，隐蔽性强；

- -sV：探测端口对应的服务版本信息；

- -O：尝试识别目标主机的操作系统版本；

- -sn：仅探测主机是否存活，不扫描端口。

**实操示例**：
    `sudo apt install nmap  # 安装nmap工具包
nmap -p 1-1000 192.168.1.100  # 扫描192.168.1.100的1-1000端口
nmap -sS -sV -p 80,443 www.baidu.com  # 半开放扫描百度80、443端口，探测服务版本
nmap -sn 192.168.1.0/24  # 探测192.168.1.0网段存活主机
` `nmap -O 192.168.1.1  # 尝试识别网关操作系统版本`

**风险等级**：中

**注意事项**：未经授权扫描他人主机可能违反法律法规，仅可用于自身运维的网络环境；部分防火墙会拦截nmap扫描包，导致扫描结果不准确。

**依赖条件**：需安装nmap工具包，安装命令：sudo apt install -y nmap。

#### 指令2：arp

- **功能**：查看和管理系统ARP缓存表，ARP缓存用于存储IP地址与MAC地址的对应关系，可用于排查IP-MAC绑定冲突、ARP欺骗等故障。

- **参数**：
    -a：查看所有ARP缓存条目，解析主机名；

- -n：查看ARP缓存条目，仅显示IP和MAC地址，不解析；

- -d IP地址：删除指定IP对应的ARP缓存条目；

- -s IP地址 MAC地址：手动绑定IP与MAC地址（临时生效）。

**实操示例**：
    `arp -n  # 查看ARP缓存表，仅显示IP和MAC
arp -d 192.168.1.1  # 删除192.168.1.1对应的ARP缓存
sudo arp -s 192.168.1.100 00:11:22:33:44:55  # 绑定IP与MAC地址
` `arp -a  # 查看ARP缓存，解析主机名`

**风险等级**：中

**注意事项**：手动绑定的IP-MAC映射为临时配置，重启系统后失效；若需永久绑定，需编辑/etc/ethers文件并执行arp -f加载；删除ARP缓存后，系统会重新发送ARP请求获取对应关系，可用于解决ARP缓存老化导致的网络故障。

**依赖条件**：无，默认预装net-tools工具包（含arp）。

### netplan配置补充（永久生效）

Ubuntu 24.04默认使用netplan管理网络配置，配置文件位于/etc/netplan/目录下（后缀为.yaml），通过编辑该文件可实现IP、网关、DNS等参数的永久生效，替代传统/etc/network/interfaces文件。

**实操示例（静态IP配置）**：
`# 编辑netplan配置文件（文件名可能为01-network-manager-all.yaml，需根据实际情况调整）
sudo nano /etc/netplan/01-network-manager-all.yaml
## 配置内容如下（注意缩进，YAML格式对缩进敏感）
network:
  version: 2
  renderer: networkd  # 使用networkd管理网络（非NetworkManager）
  ethernets:
    ens33:  # 网卡名称，通过ip addr show查看
      addresses:
        - 192.168.1.100/24  # 静态IP及子网掩码
      gateway4: 192.168.1.1  # 网关
      nameservers:
        addresses: [8.8.8.8, 1.1.1.1]  # DNS服务器
## 应用配置，使修改生效
sudo netplan apply
## 验证配置是否生效
` `ip addr show ens33`

**注意事项**：YAML文件缩进必须使用空格（不可用Tab），否则配置无效；修改配置后执行netplan apply无需重启系统即可生效；若配置错误导致网络中断，可通过控制台修改配置文件恢复。





# 07-软件包管理.md

![License: MIT](https://img.shields.io/badge/License-MIT-yellow.svg)

## 📌 章节简介

涵盖Ubuntu 24.04 LTS系统软件包管理核心指令，包括APT包管理工具、dpkg底层包操作、软件源配置及源码编译安装等内容，适用于软件安装、卸载、更新、依赖修复等日常运维场景，是系统软件管控的核心模块。

## 🔧 核心指令清单

|指令|核心功能|风险等级|依赖条件|
|---|---|---|---|
|apt update|更新软件源索引缓存|低|无，默认预装APT工具|
|apt upgrade|升级已安装软件包（不删除旧版本）|中|无，需root权限|
|apt full-upgrade|升级软件包并自动处理依赖冲突（可能删除旧包）|中高|无，需root权限|
|apt install|安装指定软件包及依赖|中|无，需root权限|
|apt remove|卸载软件包（保留配置文件）|中|无，需root权限|
|apt purge|彻底卸载软件包（删除配置文件）|中|无，需root权限|
|apt autoremove|自动删除无用依赖包|中|无，需root权限|
|dpkg -i|安装本地deb格式软件包|中高|无，需root权限，需手动处理依赖|
|dpkg -r|卸载deb包（保留配置）|中|无，需root权限|
|aptitude（冷门实用）|增强型APT工具，优化依赖解决|中|需安装aptitude工具包|
|dpkg-deb（冷门实用）|解压、构建deb包，查看包内容|低|无，默认预装|
## 📋 详细操作指南

### APT包管理（推荐优先使用）

#### 指令1：apt update

- **功能**：从配置的软件源服务器获取最新的软件包索引信息，更新本地缓存，为后续升级、安装操作提供依据（仅更新索引，不升级软件）。

- **参数**：无核心参数，可搭配-y（无需确认）、-q（静默模式，减少输出）。

- **实操示例**：
`sudo apt update  # 正常更新软件源索引
` `sudo apt update -yq  # 静默模式更新，无需手动确认`

- **风险等级**：低

- **注意事项**：执行apt upgrade、apt install前建议先运行此指令，确保获取最新软件版本；若软件源配置错误，会出现404、无法连接等报错，需先检查/etc/apt/sources.list及sources.list.d目录下配置文件。

- **依赖条件**：无，Ubuntu 24.04默认预装APT工具，需root权限。

#### 指令2：apt upgrade

- **功能**：根据本地更新后的索引缓存，升级所有已安装软件包至最新版本，保留旧版本文件，不删除任何已安装包，仅处理可兼容的依赖关系。

- **参数**：-y：自动确认所有升级操作，无需手动输入y；-V：显示软件包版本变化详情。

- **实操示例**：
`sudo apt upgrade -y  # 自动升级所有可升级软件包
` `sudo apt upgrade -yV  # 升级并显示版本变化详情`

- **风险等级**：中

- **注意事项**：升级过程中可能提示配置文件冲突，需根据提示选择保留旧配置、覆盖为新配置或手动合并；升级系统内核后需重启系统生效；生产环境建议先备份关键数据，避免升级导致软件兼容性问题。

- **依赖条件**：无，需root权限，建议先执行apt update。

#### 指令3：apt full-upgrade

- **功能**：升级软件包的同时，自动处理复杂依赖冲突，必要时会删除旧版本、不兼容的软件包，确保系统依赖链完整，适用于重大版本更新或依赖冲突无法通过普通upgrade解决的场景。

- **参数**：-y：自动确认升级及删除操作；-q：静默模式。

- **实操示例**：
`sudo apt full-upgrade -y  # 自动升级并处理依赖冲突（可能删除旧包）`

- **风险等级**：中高

- **注意事项**：可能误删与新包冲突的关键软件，生产环境使用前需谨慎评估，建议先执行apt upgrade，仅当出现依赖报错时再使用此指令；操作前务必备份重要配置和数据。

- **依赖条件**：无，需root权限，建议先执行apt update。

#### 指令4：apt install

- **功能**：从软件源安装指定软件包，自动解析并安装所需依赖包，支持同时安装多个软件包，也可指定软件版本。

- **参数**：-y：自动确认安装操作；--no-install-recommends：仅安装核心依赖，不安装推荐依赖（减少冗余）；=版本号：指定安装的软件版本。

- **实操示例**：
`sudo apt install -y nginx  # 自动安装nginx及核心依赖
sudo apt install -y nginx=1.24.0-1ubuntu3  # 安装指定版本的nginx
` `sudo apt install --no-install-recommends -y git  # 仅安装git核心依赖`

- **风险等级**：中

- **注意事项**：安装软件前需确认软件包名称正确，可通过apt search搜索；指定版本时需确保该版本在软件源中存在；若安装过程中依赖报错，可尝试apt --fix-broken install修复。

- **依赖条件**：无，需root权限，建议先执行apt update。

#### 指令5：apt remove / apt purge

- **功能**：remove用于卸载软件包，但保留配置文件（便于后续重新安装时恢复配置）；purge用于彻底卸载软件包，同时删除所有配置文件，适用于不再使用该软件的场景。

- **参数**：-y：自动确认卸载操作；--autoremove：卸载软件后自动删除其依赖的无用包。

- **实操示例**：
`sudo apt remove -y nginx  # 卸载nginx，保留配置文件
sudo apt purge -y nginx  # 彻底卸载nginx，删除所有配置
` `sudo apt purge -y --autoremove nginx  # 彻底卸载并清理无用依赖`

- **风险等级**：中

- **注意事项**：purge会删除配置文件，若配置文件有保留价值，需提前备份；卸载软件前需确认该软件无正在运行的进程，避免影响业务。

- **依赖条件**：无，需root权限。

#### 指令6：apt autoremove

- **功能**：自动识别并删除系统中无用的依赖包（即因安装其他软件而自动安装，且当前无软件依赖的包），释放磁盘空间。

- **参数**：-y：自动确认删除操作。

- **实操示例**：
`sudo apt autoremove -y  # 自动删除无用依赖包`

- **风险等级**：中

- **注意事项**：虽然该指令默认删除无用包，但极少数情况下可能误删关联包，生产环境执行前建议先查看待删除列表（不加-y参数预览）；定期执行可有效清理系统冗余。

- **依赖条件**：无，需root权限。

### dpkg底层包操作（APT工具依赖dpkg实现）

#### 指令1：dpkg -i

- **功能**：安装本地deb格式的软件包，适用于无法从软件源获取、需手动下载的软件（如第三方闭源软件），但不自动处理依赖关系。

- **参数**：-R：递归安装指定目录下所有deb包；--force-depends：强制安装，忽略依赖冲突（不推荐）。

- **实操示例**：
`sudo dpkg -i ./software.deb  # 安装单个本地deb包
sudo dpkg -R ./deb-packages/  # 递归安装目录下所有deb包
` `sudo apt --fix-broken install -y  # 修复deb包安装后的依赖问题`

- **风险等级**：中高

- **注意事项**：安装deb包后若提示依赖缺失，需执行apt --fix-broken install修复；强制安装可能导致系统依赖链损坏，仅在特殊场景下使用；deb包需匹配系统架构（amd64、arm64等）。

- **依赖条件**：无，Ubuntu默认预装dpkg，需root权限。

#### 指令2：dpkg -r / dpkg -P

- **功能**：dpkg -r用于卸载已安装的deb包，保留配置文件；dpkg -P（等同于apt purge）用于彻底卸载，删除配置文件。

- **参数**：无核心额外参数。

- **实操示例**：
`sudo dpkg -r software-name  # 卸载软件，保留配置
` `sudo dpkg -P software-name  # 彻底卸载，删除配置`

- **风险等级**：中

- **注意事项**：卸载时需指定软件包名称（而非deb文件名），可通过dpkg -l查看已安装包名称；若卸载后有残留文件，需手动清理安装目录。

- **依赖条件**：无，需root权限。

### 冷门实用工具

#### 指令1：aptitude

- **功能**：增强型APT包管理工具，采用更智能的依赖解决算法，可处理apt无法解决的复杂依赖冲突，同时支持交互式操作界面。

- **参数**：install/remove/purge：功能与apt对应指令一致；search：搜索软件包；show：查看软件包详情。

- **实操示例**：
`sudo apt install -y aptitude  # 安装aptitude
sudo aptitude install -y nginx  # 安装nginx，优化依赖解决
sudo aptitude search git  # 搜索git相关软件包
` `sudo aptitude show nginx  # 查看nginx软件包详情`

- **风险等级**：中

- **注意事项**：交互式界面按q键退出，适合排查依赖问题；在apt无法解决依赖报错时，可尝试用aptitude替代执行安装/升级操作。

- **依赖条件**：需安装aptitude工具包，安装命令：sudo apt install -y aptitude。

#### 指令2：dpkg-deb

- **功能**：deb包专用工具，支持解压deb包查看内容、构建自定义deb包、查看包信息等，适用于软件包开发或排查deb包问题。

- **参数**：-x  deb包  目标目录：解压deb包内容到指定目录；-I  deb包：查看deb包的详细信息（版本、依赖、安装目录等）；-b  源目录  deb包名：构建deb包。

- **实操示例**：
`dpkg-deb -x software.deb ./extracted/  # 解压deb包到指定目录
dpkg-deb -I software.deb  # 查看deb包详细信息
` `dpkg-deb -b ./source-dir/ custom.deb  # 从源目录构建自定义deb包`

- **风险等级**：低

- **注意事项**：解压deb包仅用于查看内容，不代表安装；构建deb包需遵循deb包规范，否则可能无法正常安装。

- **依赖条件**：无，Ubuntu默认预装dpkg-deb。

### 软件源配置补充

Ubuntu软件源配置文件位于/etc/apt/sources.list，额外软件源配置位于/etc/apt/sources.list.d/目录（.list后缀文件）。日常运维中可根据需求替换为国内镜像源（如阿里云、华为云、清华镜像），提升更新、安装速度。

**实操示例（替换为阿里云镜像源）**：
`# 备份原有软件源配置
sudo cp /etc/apt/sources.list /etc/apt/sources.list.bak
## 替换为阿里云镜像源（Ubuntu 24.04）
sudo tee /etc/apt/sources.list << 'EOF'
deb http://mirrors.aliyun.com/ubuntu/ noble main restricted universe multiverse
deb-src http://mirrors.aliyun.com/ubuntu/ noble main restricted universe multiverse
deb http://mirrors.aliyun.com/ubuntu/ noble-updates main restricted universe multiverse
deb-src http://mirrors.aliyun.com/ubuntu/ noble-updates main restricted universe multiverse
deb http://mirrors.aliyun.com/ubuntu/ noble-backports main restricted universe multiverse
deb-src http://mirrors.aliyun.com/ubuntu/ noble-backports main restricted universe multiverse
deb http://mirrors.aliyun.com/ubuntu/ noble-security main restricted universe multiverse
deb-src http://mirrors.aliyun.com/ubuntu/ noble-security main restricted universe multiverse
EOF
## 更新软件源索引
` `sudo apt update`

**注意事项**：替换软件源后需执行apt update更新索引；不同Ubuntu版本对应不同镜像源标识（24.04为noble），避免混用；添加第三方软件源后，需导入对应GPG密钥，否则可能提示签名验证失败。

# 08-磁盘管理与分区.md

![License: MIT](https://img.shields.io/badge/License-MIT-yellow.svg)

## 📌 章节简介

涵盖Ubuntu 24.04 LTS系统磁盘识别、分区规划、文件系统格式化、磁盘挂载/卸载、容量监控及文件系统修复等核心操作，同时包含LVM逻辑卷管理（冷门实用），适用于磁盘初始化、容量扩展、存储故障排查等运维场景，是保障系统存储稳定运行的关键模块。

## 🔧 核心指令清单

|指令|核心功能|风险等级|依赖条件|
|---|---|---|---|
|lsblk|查看磁盘、分区及挂载关系|低|无，默认预装|
|fdisk|磁盘分区（支持MBR格式，最大2TB）|中高|无，默认预装，需root权限|
|parted|磁盘分区（支持GPT/MBR，无容量限制）|中高|无，默认预装，需root权限|
|mkfs|格式化分区为指定文件系统（ext4/xfs等）|高|无，需root权限|
|mount|临时挂载文件系统到指定目录|中|无，需root权限|
|umount|卸载已挂载的文件系统|中|无，需root权限|
|df|查看挂载点容量使用情况|低|无，默认预装|
|du|查看目录/文件占用磁盘空间|低|无，默认预装|
|fsck|检查并修复文件系统故障|中高|无，需root权限，不可挂载时执行|
|blkid|查看块设备UUID及文件系统类型|低|无，默认预装|
|pvcreate/vgcreate/lvcreate（冷门实用）|创建LVM逻辑卷（灵活扩展容量）|中高|需安装lvm2工具包，需root权限|
## 📋 详细操作指南

### 磁盘识别与信息查看

#### 指令1：lsblk

- **功能**：以树形结构展示磁盘、分区、挂载点及设备编号，直观呈现存储设备拓扑关系，是磁盘管理的首选信息查看工具。

- **参数**：
    -f：显示文件系统类型、UUID及挂载点信息；

- -p：显示设备完整路径（而非简化路径）；

- -o 字段名：自定义显示字段（如NAME,SIZE,TYPE,MOUNTPOINT）。

**实操示例**：
    `lsblk  # 查看磁盘及分区基本信息
lsblk -f  # 查看磁盘分区的文件系统和UUID
lsblk -o NAME,SIZE,TYPE,MOUNTPOINT  # 仅显示指定字段信息
` `lsblk -p /dev/sdb  # 显示/dev/sdb设备的完整路径及详情`

**风险等级**：低

**注意事项**：设备编号规则（如/dev/sda为第一块磁盘，/dev/sda1为其第一个分区），SSD和机械硬盘无明显标识，需结合容量判断；未挂载分区无MOUNTPOINT字段。

**依赖条件**：无，Ubuntu 24.04默认预装util-linux工具包（含lsblk）。

#### 指令2：blkid

- **功能**：查询块设备（磁盘分区、逻辑卷）的UUID、文件系统类型、标签等信息，常用于配置永久挂载（/etc/fstab）时获取UUID。

- **参数**：
    -s TYPE：仅显示文件系统类型；

- -s UUID：仅显示设备UUID；

- 设备路径：指定查看某一设备信息（如blkid /dev/sdb1）。

**实操示例**：
    `blkid  # 查看所有块设备的UUID和文件系统
blkid -s UUID /dev/sdb1  # 仅显示/dev/sdb1的UUID
` `blkid /dev/sda2  # 查看/dev/sda2的详细信息`

**风险等级**：低

**注意事项**：UUID是设备唯一标识，用UUID挂载可避免设备编号变动（如新增磁盘导致编号变化）引发的挂载失败；未格式化分区无文件系统信息，无法显示UUID。

**依赖条件**：无，默认预装util-linux工具包。

### 磁盘分区操作

#### 指令1：fdisk（MBR分区表）

- **功能**：传统磁盘分区工具，仅支持MBR分区表格式，单磁盘最大容量2TB，最多4个主分区或3个主分区+1个扩展分区，适用于小容量磁盘场景。

- **核心交互命令**：
    n：创建新分区；

- d：删除现有分区；

- p：显示分区表信息；

- w：保存分区表并退出；

- q：放弃修改并退出；

- t：修改分区类型（如Linux、swap）。

**实操示例（创建分区）**：
    `sudo fdisk /dev/sdb  # 对/dev/sdb磁盘进行分区操作
## 交互流程：
n  # 新建分区
p  # 选择主分区（默认）
1  # 分区编号1
（回车默认起始扇区）
+100G  # 分区大小100GB
p  # 查看分区表，确认分区信息
w  # 保存并退出，分区生效
## 刷新分区表（无需重启）
` `sudo partprobe /dev/sdb`

**风险等级**：中高

**注意事项**：分区操作前务必备份数据，删除分区会直接清除数据；超过2TB的磁盘需使用parted工具创建GPT分区表；修改分区表后需执行partprobe刷新，否则系统无法识别新分区。

**依赖条件**：无，默认预装util-linux工具包，所有操作需root权限。

#### 指令2：parted（GPT/MBR分区表）

- **功能**：新一代分区工具，支持GPT和MBR两种分区表格式，无磁盘容量限制（GPT最大支持18EB），可创建超过4个分区，适用于大容量磁盘及SSD场景。

- **核心交互命令**：
    mklabel gpt/mbr：创建GPT或MBR分区表；

- mkpart：创建新分区（需指定分区名称、文件系统类型、起始/结束位置）；

- rm 分区编号：删除指定分区；

- print：显示分区表信息；

- quit：退出parted工具。

**实操示例（创建GPT分区）**：
    `sudo parted /dev/sdb  # 对/dev/sdb磁盘操作
mklabel gpt  # 创建GPT分区表（会清除所有数据，确认输入yes）
mkpart data ext4 0% 100GB  # 创建名为data、ext4格式、100GB的分区
mkpart backup xfs 100GB 100%  # 剩余空间创建名为backup、xfs格式的分区
print  # 查看分区结果
quit  # 退出
` `sudo partprobe /dev/sdb  # 刷新分区表`

**风险等级**：中高

**注意事项**：mklabel命令会彻底清除磁盘所有数据，务必确认磁盘无重要内容；起始/结束位置支持百分比（0%为磁盘开头，100%为结尾）或具体容量（如100GB）；GPT分区表无需区分主分区和扩展分区，可直接创建多个分区。

**依赖条件**：无，默认预装parted工具，需root权限。

### 文件系统格式化

#### 指令：mkfs

- **功能**：将磁盘分区格式化为指定文件系统，使系统能够识别和读写分区数据，常用文件系统包括ext4（Ubuntu默认）、xfs（高性能）、swap（交换分区）。

- **参数与子命令**：
    mkfs.ext4：格式化为ext4文件系统（最常用）；

- mkfs.xfs：格式化为xfs文件系统（适合大容量存储）；

- mkfs.swap：格式化为交换分区；

- -L 标签名：给文件系统设置标签（便于识别）；

- -m 保留百分比：设置根用户保留空间（ext4默认5%，可减少为1%节省空间）。

**实操示例**：
    `# 格式化为ext4文件系统，设置标签为data
sudo mkfs.ext4 -L data /dev/sdb1
## 格式化为xfs文件系统
sudo mkfs.xfs /dev/sdb2
## 格式化为交换分区
sudo mkfs.swap /dev/sdb3
## ext4文件系统减少根保留空间为1%
` `sudo mkfs.ext4 -m 1 -L backup /dev/sdc1`

**风险等级**：高

**注意事项**：格式化会彻底清除分区内所有数据，操作前必须备份；交换分区需单独格式化，且需通过swapon启用；文件系统类型需与业务场景匹配（ext4兼容性强，xfs读写性能更优）。

**依赖条件**：无，mkfs默认预装，xfs格式需安装xfsprogs（sudo apt install -y xfsprogs）。

### 磁盘挂载与卸载

#### 指令1：mount（临时挂载）

- **功能**：将格式化后的分区挂载到系统指定目录（挂载点），使系统能够通过该目录访问分区数据，临时挂载重启后失效。

- **参数**：
    -t 文件系统类型：指定文件系统类型（如ext4、xfs，通常可省略，系统自动识别）；

- -o 选项：挂载选项（如rw读写模式、ro只读模式、noatime禁用访问时间记录）；

- -a：根据/etc/fstab配置自动挂载所有未挂载分区。

**实操示例**：
    `# 创建挂载点目录
sudo mkdir -p /mnt/data
## 临时挂载/dev/sdb1到/mnt/data
sudo mount /dev/sdb1 /mnt/data
## 只读模式挂载
sudo mount -o ro /dev/sdb2 /mnt/backup
## 启用noatime选项挂载（提升性能）
` `sudo mount -o noatime /dev/sdb1 /mnt/data`

**风险等级**：中

**注意事项**：挂载点目录必须提前创建；同一挂载点不可同时挂载多个分区；挂载后原挂载点目录下的文件会被暂时隐藏，卸载后恢复可见。

**依赖条件**：无，默认预装util-linux工具包，需root权限。

#### 指令2：umount（卸载）

- **功能**：卸载已挂载的文件系统，释放分区与挂载点的关联，卸载前需确保无进程访问该挂载点。

- **参数**：
    -l：强制卸载（适用于进程占用无法正常卸载的场景，谨慎使用）；

- -a：卸载所有已挂载的非根文件系统（排除/dev/root）。

**实操示例**：
    `# 按挂载点卸载
sudo umount /mnt/data
## 按设备路径卸载
sudo umount /dev/sdb1
## 强制卸载被占用的分区
` `sudo umount -l /mnt/backup`

**风险等级**：中

**注意事项**：卸载前需通过fuser或lsof命令检查挂载点是否被进程占用（如fuser -m /mnt/data），强行卸载可能导致数据损坏；根分区（/）无法卸载。

**依赖条件**：无，默认预装util-linux工具包，需root权限。

#### 永久挂载配置（/etc/fstab）

- **功能**：通过编辑/etc/fstab文件，实现分区开机自动挂载，避免每次重启后手动挂载，推荐使用UUID作为设备标识，提升稳定性。

- **配置格式**：每行对应一个挂载项，格式为：UUID=设备UUID  挂载点  文件系统类型  挂载选项  0  0

- **实操示例**：
    `# 1. 获取/dev/sdb1的UUID
blkid /dev/sdb1  # 假设UUID为1234-ABCD-1234-ABCD
## 2. 编辑/etc/fstab文件
sudo nano /etc/fstab
## 添加以下内容（永久挂载/dev/sdb1到/mnt/data）
UUID=1234-ABCD-1234-ABCD  /mnt/data  ext4  defaults,noatime  0  0
## 3. 验证配置（无报错则正常）
sudo mount -a
## 4. 查看挂载结果
` `df -h /mnt/data`

- **风险等级**：中高

- **注意事项**：/etc/fstab格式错误会导致系统无法启动，修改前务必备份（sudo cp /etc/fstab /etc/fstab.bak）；挂载选项defaults包含rw、suid、dev等默认属性，可结合需求添加noatime等优化选项；验证配置时若报错，需及时修正，避免重启故障。

### 磁盘容量监控

#### 指令1：df

- **功能**：查看各挂载点的磁盘容量使用情况，包括总容量、已用容量、可用容量及使用率，是排查磁盘满溢的核心工具。

- **参数**：
    -h：以人类可读格式显示容量（KB/MB/GB）；

- -T：显示文件系统类型；

- -x 文件系统类型：排除指定文件系统（如tmpfs）；

- 挂载点/设备：仅显示指定挂载点或设备的容量信息。

**实操示例**：
    `df -h  # 查看所有挂载点容量使用情况
df -hT  # 显示文件系统类型
df -h /mnt/data  # 仅查看/mnt/data挂载点
` `df -h -x tmpfs  # 排除tmpfs文件系统`

**风险等级**：低

**注意事项**：若根分区（/）使用率超过90%，需及时清理冗余文件，避免影响系统运行；tmpfs为内存文件系统，占用内存空间，并非磁盘空间。

**依赖条件**：无，默认预装coreutils工具包。

#### 指令2：du

- **功能**：统计目录或文件占用的磁盘空间，可精准定位大文件和大目录，补充df指令的不足（df显示挂载点整体使用率，du定位具体占用源）。

- **参数**：
    -h：人类可读格式显示；

- -s：仅显示总容量，不列出子目录/文件详情；

- -a：统计所有文件（包括隐藏文件）的占用空间；

- --max-depth=N：限制统计深度（如--max-depth=1仅统计一级子目录）。

**实操示例**：
    `# 统计/var目录总占用空间
du -sh /var
## 统计/home目录下一级子目录占用情况
du -h --max-depth=1 /home
## 查找/目录下大于1GB的文件
du -ah / --threshold=1G 2>/dev/null
## 统计当前目录所有文件占用空间
` `du -ah .`

**风险等级**：低

**注意事项**：统计根目录（/）时需加sudo，否则部分目录无访问权限；2>/dev/null用于屏蔽无权限访问的错误提示；大文件排查常用du结合sort命令（如du -ah /var | sort -hr | head -10）。

**依赖条件**：无，默认预装coreutils工具包。

### 文件系统修复

#### 指令：fsck

- **功能**：检查文件系统完整性，修复逻辑错误（如索引损坏、文件碎片、超级块异常），适用于磁盘挂载失败、系统异常关机导致的文件系统故障。

- **参数与子命令**：
    fsck.ext4：修复ext4文件系统；

- fsck.xfs：修复xfs文件系统（xfs需用xfs_repair，fsck.xfs仅检查）；

- -y：自动确认所有修复操作，无需手动输入；

- -f：强制检查（即使文件系统显示正常）。

**实操示例**：
    `# 检查并修复ext4分区（先卸载）
sudo umount /dev/sdb1
sudo fsck.ext4 -y /dev/sdb1
## 强制检查ext4分区
sudo fsck.ext4 -f /dev/sdb1
## 修复xfs分区（xfs专用命令）
sudo umount /dev/sdb2
` `sudo xfs_repair /dev/sdb2`

**风险等级**：中高

**注意事项**：修复前必须卸载分区，否则会导致数据损坏；严重的物理坏道无法通过fsck修复，需更换磁盘；xfs文件系统不支持fsck修复，必须使用xfs_repair工具。

**依赖条件**：无，fsck默认预装，xfs_repair需安装xfsprogs工具包。

### 冷门实用工具（LVM逻辑卷管理）

- **功能**：LVM（逻辑卷管理）可将多个物理磁盘/分区整合为卷组，再划分为逻辑卷使用，支持动态扩展/缩减容量，无需重新分区和格式化，适用于存储需求多变的场景（如数据库服务器）。

- **核心指令**：
    pvcreate：将物理分区标记为LVM物理卷；

- vgcreate：将多个物理卷整合为卷组；

- lvcreate：从卷组中划分逻辑卷；

- lvextend：扩展逻辑卷容量；

- vgdisplay/lvdisplay：查看卷组/逻辑卷信息。

**实操示例（创建LVM逻辑卷）**：
    `# 1. 安装LVM工具包
sudo apt install -y lvm2
## 2. 将/dev/sdb1、/dev/sdc1标记为物理卷
sudo pvcreate /dev/sdb1 /dev/sdc1
## 3. 创建卷组vg_data，包含上述两个物理卷
sudo vgcreate vg_data /dev/sdb1 /dev/sdc1
## 4. 从卷组中划分200GB逻辑卷lv_data
sudo lvcreate -L 200G -n lv_data vg_data
## 5. 格式化逻辑卷为ext4
sudo mkfs.ext4 /dev/vg_data/lv_data
## 6. 挂载逻辑卷（永久挂载需配置/etc/fstab）
sudo mkdir -p /mnt/lvm_data
sudo mount /dev/vg_data/lv_data /mnt/lvm_data
## 7. 扩展逻辑卷（新增100GB）
sudo lvextend -L +100G /dev/vg_data/lv_data
` `sudo resize2fs /dev/vg_data/lv_data  # ext4扩容后同步文件系统`

**风险等级**：中高

**注意事项**：创建物理卷前需将分区类型改为LVM（fdisk中t命令选择8e类型）；逻辑卷扩容后需同步文件系统（ext4用resize2fs，xfs用xfs_growfs）；缩减逻辑卷容量风险极高，需提前备份数据。

**依赖条件**：需安装lvm2工具包，所有操作需root权限。

# 09-日志管理.md

![License: MIT](https://img.shields.io/badge/License-MIT-yellow.svg)

## 📌 章节简介

涵盖Ubuntu 24.04 LTS系统日志管理核心内容，包括systemd-journald日志查看、rsyslog服务配置、日志轮转策略及日志分析工具使用，适用于日志收集、故障排查、审计追溯等运维场景，是保障系统可观测性与问题定位的关键模块。Ubuntu 24.04默认采用systemd-journald与rsyslog协同工作，兼顾日志实时查看与持久化存储。

## 🔧 核心指令清单

|指令/工具|核心功能|风险等级|依赖条件|
|---|---|---|---|
|journalctl|查看systemd-journald日志，支持多条件过滤|低|无，默认预装systemd-journald|
|rsyslogd|系统日志持久化存储、转发，配置日志规则|中|无，默认预装rsyslog服务|
|logrotate|日志轮转，切割大日志、删除旧日志，释放空间|中|无，默认预装logrotate工具|
|tail|实时跟踪日志文件更新，查看尾部内容|低|无，默认预装coreutils工具包|
|grep|过滤日志内容，匹配关键字、正则表达式|低|无，默认预装coreutils工具包|
|logwatch（冷门实用）|日志分析报告生成，汇总系统事件、异常信息|低|需安装logwatch工具包|
|journalctl --vacuum-size|清理journald日志，限制日志存储容量|中|无，依赖systemd-journald|
## 📋 详细操作指南

### systemd-journald日志管理（实时日志核心）

#### 指令：journalctl

- **功能**：管理和查看systemd-journald服务收集的日志，日志默认存储在内存中（重启后丢失，可配置持久化），支持按服务、时间、优先级等多维度过滤，定位问题高效便捷。

- **核心参数**：
-u 服务名：仅查看指定服务的日志（如nginx、sshd）；

- -b：查看当前系统启动后的日志，-b -1查看上一次启动日志；

- --since/--until：按时间过滤（如--since "1h ago"、--since "2024-08-01 08:00:00"）；

- -p 优先级：按日志级别过滤（emerg(0)、alert(1)、crit(2)、err(3)、warning(4)、info(5)、debug(7)）；

- -f：实时跟踪日志更新（类似tail -f）；

- --no-pager：日志内容一次性输出，不进入分页模式。

**实操示例**：`journalctl -u nginx -f  # 实时跟踪nginx服务日志
journalctl -u sshd --since "1h ago" --until "30min ago"  # 查看1小时前到30分钟前的sshd日志
journalctl -p err -b  # 查看当前启动周期内的错误级别日志
journalctl --since "2024-08-01" --until "2024-08-02" -u mysql  # 按日期范围查看mysql日志
` `journalctl --no-pager -n 50  # 一次性输出最后50条日志，不分页`

**风险等级**：低

**注意事项**：默认日志非持久化，系统重启后丢失，需配置/etc/systemd/journald.conf开启持久化；日志优先级从emerg到debug依次降低，定位故障优先查看err及以上级别；普通用户可查看部分日志，敏感日志需root权限。

**依赖条件**：无，Ubuntu 24.04默认启用systemd-journald服务，无需额外安装。

#### journald日志持久化配置

- **功能**：将journald日志从内存存储改为磁盘存储，实现日志永久保留，便于后续追溯历史故障。

- **实操示例**：
`# 1. 编辑journald配置文件
sudo nano /etc/systemd/journald.conf
## 2. 修改以下参数（取消注释并配置）
Storage=persistent  # 启用磁盘持久化存储
Compress=yes  # 启用日志压缩，节省空间
SystemMaxUse=10G  # 限制journald日志总占用空间为10GB
MaxRetentionSec=7day  # 日志最大保留时间7天
## 3. 重启journald服务使配置生效
sudo systemctl restart systemd-journald
## 4. 验证配置，日志会存储到/var/log/journal目录
` `ls -ld /var/log/journal/`

- **风险等级**：中

- **注意事项**：需合理设置日志存储上限和保留时间，避免占用过多磁盘空间；配置后首次生成日志会自动创建/var/log/journal目录，权限为root:systemd-journal；修改配置前建议备份原文件。

### rsyslog日志管理（持久化与转发）

#### 工具：rsyslogd

- **功能**：rsyslog是系统日志守护进程，负责收集系统内核、应用程序日志，将其写入本地文件（默认/var/log/目录下），还支持将日志转发至远程日志服务器，实现集中化日志管理。Ubuntu 24.04默认日志文件包括/var/log/syslog（系统综合日志）、/var/log/auth.log（认证日志）、/var/log/kern.log（内核日志）等。

- **核心配置**：配置文件位于/etc/rsyslog.conf，额外规则文件位于/etc/rsyslog.d/目录（.conf后缀），支持按日志来源、级别定义存储路径或转发规则。

- **实操示例（本地日志规则配置）**：
`# 1. 创建自定义日志规则文件
sudo nano /etc/rsyslog.d/nginx.conf
## 2. 添加规则，将nginx日志写入/var/log/nginx/access.log和error.log
if $programname == 'nginx' then {
  if $msg contains 'GET' or $msg contains 'POST' then /var/log/nginx/access.log
  else /var/log/nginx/error.log
  stop  # 避免日志重复写入syslog
}
## 3. 重启rsyslog服务生效
sudo systemctl restart rsyslog
## 4. 验证服务状态
` `sudo systemctl status rsyslog`

- **实操示例（日志转发至远程服务器）**：
`# 在本地服务器rsyslog配置中添加转发规则
sudo nano /etc/rsyslog.d/remote.conf
## 格式：*.* @@远程服务器IP:514（@@表示TCP协议，@表示UDP协议）
*.* @@192.168.1.200:514
## 重启服务
sudo systemctl restart rsyslog
## 远程服务器需开启rsyslog接收功能，配置/etc/rsyslog.conf
module(load="imtcp")  # 加载TCP接收模块
input(type="imtcp" port="514")  # 监听514端口
$template RemoteLogs,"/var/log/remote/%HOSTNAME%/syslog.log"  # 按客户端主机名存储
` `*.* ?RemoteLogs  # 应用模板`

- **风险等级**：中

- **注意事项**：配置日志转发需确保本地与远程服务器网络通畅，514端口未被防火墙拦截；自定义日志目录需提前创建，确保rsyslog用户有写入权限；错误的配置会导致日志无法正常存储或转发，建议修改后测试日志生成。

- **依赖条件**：无，Ubuntu 24.04默认预装rsyslog服务，默认开机自启。

### 日志轮转（logrotate）

#### 工具：logrotate

- **功能**：自动对超大日志文件进行切割（轮转），生成按日期/序号命名的日志文件，同时删除过期日志，防止单一日志文件过大占用磁盘空间，保障日志持续写入。logrotate通过定时任务（/etc/cron.daily/logrotate）每日执行一次，也可手动触发。

- **核心配置**：主配置文件/etc/logrotate.conf，自定义轮转规则文件位于/etc/logrotate.d/目录，每个应用可单独配置轮转策略（如nginx、mysql）。

- **常用轮转参数**：
daily/weekly/monthly：按日/周/月轮转；

- size 100M：日志达到100M时触发轮转（优先于时间规则）；

- rotate 7：保留7个轮转日志文件，超出则删除最旧的；

- compress：轮转后对旧日志进行gzip压缩；

- delaycompress：延迟压缩，保留最近一次轮转的日志不压缩；

- missingok：日志文件不存在时不报错；

- notifempty：日志文件为空时不执行轮转；

- create 644 root root：轮转后创建新日志文件，指定权限和所有者。

**实操示例（nginx日志轮转配置）**：
`# 1. 创建nginx日志轮转规则文件
sudo nano /etc/logrotate.d/nginx
## 2. 添加以下配置
/var/log/nginx/*.log {
  daily
  size 50M
  rotate 14
  compress
  delaycompress
  missingok
  notifempty
  create 640 www-data www-data
  postrotate
    # 轮转后重启nginx，确保日志写入新文件
    sudo systemctl reload nginx > /dev/null 2>&1 || true
  endscript
}
## 3. 手动测试轮转（无需等待定时任务）
sudo logrotate -d /etc/logrotate.d/nginx  # -d为调试模式，不实际执行
` `sudo logrotate -f /etc/logrotate.d/nginx  # -f强制执行轮转`

**风险等级**：中

**注意事项**：配置postrotate脚本时，需确保服务重载/重启命令正确，避免影响应用运行；压缩后的日志文件后缀为.gz，可通过zcat、gunzip查看；轮转规则中权限设置需与应用运行用户匹配，避免日志写入失败。

**依赖条件**：无，Ubuntu 24.04默认预装logrotate，且已配置每日定时任务。

### 日志实时查看与过滤

#### 指令1：tail

- **功能**：查看日志文件尾部内容，支持实时跟踪文件更新，是日常监控应用运行状态的常用工具，常与grep结合使用过滤关键字。

- **核心参数**：
-f：实时跟踪日志文件新增内容；

- -n 行数：指定查看尾部行数（默认10行）；

- -F：结合-f和--retry，日志文件被轮转（删除/重命名）后自动重新跟踪新文件。

**实操示例**：
`tail -f /var/log/syslog  # 实时查看系统综合日志
tail -n 20 /var/log/auth.log  # 查看auth.log尾部20行内容
tail -F /var/log/nginx/error.log | grep "error"  # 实时跟踪nginx错误日志并过滤error关键字
` `tail -f /var/log/kern.log | grep -i "warning"  # 忽略大小写过滤warning日志`

**风险等级**：低

**注意事项**：实时跟踪日志时按Ctrl+C退出；对于超大日志文件，避免使用cat命令直接打开，优先用tail、head或less查看。

#### 指令2：grep

- **功能**：在日志文件中搜索匹配的关键字、正则表达式，快速过滤出目标日志，定位故障相关信息，是日志分析的核心工具。

- **核心参数**：
-i：忽略大小写匹配；

- -v：反向匹配，显示不包含关键字的行；

- -n：显示匹配行的行号；

- -E：启用扩展正则表达式；

- --color=auto：高亮显示匹配的关键字。

**实操示例**：
`grep -i "failed" /var/log/auth.log  # 查找auth.log中所有包含failed（忽略大小写）的日志
grep -n "error" /var/log/nginx/error.log  # 查找error日志并显示行号
grep -E "192.168.1.[0-9]+" /var/log/nginx/access.log  # 用正则匹配访问日志中的192.168.1段IP
` `grep -v "info" /var/log/syslog  # 显示不包含info的系统日志`

**风险等级**：低

**注意事项**：搜索超大日志文件时，可结合head、tail减少搜索范围，提升效率；正则表达式中特殊字符（如.、*）需转义或使用-E参数。

### 冷门实用工具

#### 工具：logwatch

- **功能**：自动化日志分析工具，可汇总指定时间段内的系统日志，生成结构化报告，包含登录事件、服务状态、错误信息、磁盘使用等内容，支持邮件发送报告，适用于日常运维审计。

- **实操示例**：
`# 1. 安装logwatch
sudo apt install -y logwatch
## 2. 生成当日日志报告，输出到终端
logwatch --service all --range today
## 3. 生成nginx服务近7天日志报告，保存到文件
logwatch --service nginx --range 7days --output file --filename /tmp/nginx-log-report.txt
## 4. 配置邮件发送报告（需安装postfix邮件服务）
sudo nano /etc/logwatch/conf/logwatch.conf
## 添加配置
Output = mail
MailTo = admin@example.com
MailFrom = logwatch@server.local
## 5. 每日自动生成报告，添加到定时任务
sudo crontab -e
## 添加一行（每日凌晨2点执行）
` `0 2 * * * /usr/sbin/logwatch --service all --range yesterday`

- **风险等级**：低

- **注意事项**：logwatch默认按服务分类生成报告，支持自定义配置过滤规则（配置文件位于/etc/logwatch/conf/services/）；发送邮件需确保系统已配置邮件服务（如postfix、sendmail）；报告内容可根据需求调整，避免冗余信息。

- **依赖条件**：需安装logwatch工具包，邮件功能需额外安装邮件服务。

### 日志清理与空间释放

- **journald日志清理**：
`# 按容量清理，保留最近10GB日志
sudo journalctl --vacuum-size=10G
## 按时间清理，保留最近7天日志
sudo journalctl --vacuum-time=7d
## 清理所有日志（谨慎操作）
` `sudo journalctl --rotate && sudo journalctl --vacuum-time=1s`

- **手动清理旧日志**：
`# 删除30天前的nginx压缩日志
sudo find /var/log/nginx -name "*.log.gz" -mtime +30 -delete
## 清空当前日志文件（不删除文件，避免应用写入失败）
sudo > /var/log/syslog
` `# 注意：清空日志后需确保应用仍在正常写入，可通过tail -f验证`

- **风险等级**：中

- **注意事项**：清理日志前建议确认无重要审计信息，必要时备份；避免直接删除正在写入的日志文件，优先使用清空（> 文件名）或logrotate轮转；定期清理日志应纳入日常运维计划，避免磁盘空间耗尽。

## 10-压缩解压.md

![License: MIT](https://img.shields.io/badge/License-MIT-yellow.svg)

## 📌 章节简介

涵盖Ubuntu 24.04 LTS系统常用压缩解压工具（tar、gzip、bzip2、xz、zip等）的核心操作，包括文件归档、单文件压缩、跨平台压缩及解压技巧，适用于文件备份、传输、空间优化等运维场景。同时包含冷门实用参数，提升压缩解压效率与灵活性，是日常运维中文件处理的核心模块。

## 🔧 核心指令清单

|指令/工具|核心功能|风险等级|依赖条件|
|---|---|---|---|
|tar|文件归档，支持gzip/bzip2/xz压缩格式|低|无，默认预装|
|gzip/gunzip|单文件gzip格式压缩/解压，压缩比中等|低|无，默认预装|
|bzip2/bunzip2|单文件bzip2格式压缩/解压，压缩比高于gzip|低|无，默认预装|
|xz/unxz|单文件xz格式压缩/解压，压缩比最高，速度较慢|低|无，默认预装|
|zip/unzip|跨平台zip格式压缩/解压，支持多文件打包|低|需安装zip/unzip工具包|
|7z（冷门实用）|7z格式压缩/解压，压缩比极高，支持多种格式|低|需安装p7zip-full工具包|
## 📋 详细操作指南

### tar归档与多格式压缩（核心工具）

#### 指令：tar

- **功能**：核心文件归档工具，本身不压缩，需结合压缩算法（gzip、bzip2、xz）实现压缩，支持多文件/目录打包，保留文件属性（权限、时间戳），是Ubuntu运维中最常用的压缩解压工具。

- **核心参数**：
                  -c：创建归档文件（打包）；

- -x：解压归档文件；

- -v：显示操作过程（ verbose，便于排查问题）；

- -f 文件名：指定归档文件名（必须放在参数最后）；

- -z：使用gzip压缩/解压（对应后缀.tar.gz/.tgz）；

- -j：使用bzip2压缩/解压（对应后缀.tar.bz2）；

- -J：使用xz压缩/解压（对应后缀.tar.xz）；

- --exclude=文件名：打包时排除指定文件/目录（冷门实用）；

- -C 目录：解压到指定目录（而非当前目录）。

**实操示例**：
                  `
## 1. 打包并gzip压缩（常用）
tar -zcvf data.tar.gz /home/data  # 打包/home/data目录为data.tar.gz
## 2. 打包并bzip2压缩（压缩比更高）
tar -jcvf logs.tar.bz2 /var/log/*.log  # 打包日志文件为tar.bz2
## 3. 打包并xz压缩（压缩比最高，速度较慢）
tar -Jcvf backup.tar.xz /etc  # 打包/etc目录为tar.xz
## 4. 解压到当前目录
tar -zxvf data.tar.gz  # 解压tar.gz文件
tar -Jxvf backup.tar.xz  # 解压tar.xz文件
## 5. 解压到指定目录
tar -zxvf data.tar.gz -C /tmp/  # 解压到/tmp目录
## 6. 打包时排除指定文件
tar -zcvf data.tar.gz /home/data --exclude=tmp.txt --exclude=cache/
## 7. 查看归档文件内容（不解压）
tar -ztvf data.tar.gz
` `                      `

**风险等级**：低

**注意事项**：压缩时路径建议使用绝对路径，避免解压后路径混乱；解压前需确认目标目录空间充足；--exclude参数可多次使用，排除多个文件/目录；xz格式压缩速度较慢，适合对压缩比要求高、不紧急的场景（如备份归档）。

**依赖条件**：无，Ubuntu 24.04默认预装tar工具，支持所有压缩格式。

### 单文件压缩与解压

#### 指令1：gzip/gunzip

- **功能**：单文件gzip格式压缩/解压，压缩速度快，压缩比中等，压缩后原文件会被删除（保留压缩文件），支持批量压缩。

- **核心参数**：
                  -k：保留原文件（默认删除，冷门实用）；

- -d：解压文件（等同于gunzip）；

- -1~-9：压缩级别（1最快压缩比最低，9最慢压缩比最高，默认6）。

**实操示例**：
                  `
## 压缩文件，删除原文件
gzip test.txt  # 生成test.txt.gz，删除test.txt
## 压缩并保留原文件
gzip -k test.txt  # 同时保留test.txt和test.txt.gz
## 批量压缩当前目录下所有txt文件
gzip *.txt
## 解压文件
gunzip test.txt.gz  # 解压为test.txt，删除压缩包
gzip -d test.txt.gz  # 与gunzip功能一致
## 调整压缩级别（快速压缩）
gzip -1 -k largefile.dat
` `                      `

**风险等级**：低

**注意事项**：gzip仅支持单文件压缩，无法压缩目录；批量压缩时会对每个文件单独压缩，而非打包后压缩；重要文件建议使用-k参数保留原文件，避免误操作丢失数据。

**依赖条件**：无，默认预装gzip工具。

#### 指令2：bzip2/bunzip2

- **功能**：单文件bzip2格式压缩/解压，压缩比高于gzip，速度慢于gzip，同样默认删除原文件，支持压缩级别调整。

- **核心参数**：
-k：保留原文件；

- -d：解压文件（等同于bunzip2）；

- -1~-9：压缩级别（默认9，压缩比最高）。

**实操示例**：
                  `
## 压缩文件，保留原文件
bzip2 -k test.txt  # 生成test.txt.bz2，保留原文件
## 解压文件
bunzip2 test.txt.bz2  # 解压为test.txt，删除压缩包
bzip2 -d test.txt.bz2  # 与bunzip2功能一致
## 低级别快速压缩
bzip2 -1 -k largefile.dat
` `                      `

**风险等级**：低

**注意事项**：不支持目录压缩，仅适用于单文件；压缩大文件时耗时较长，需结合业务场景选择；解压时若原文件已存在，会提示覆盖，需手动确认。

**依赖条件**：无，默认预装bzip2工具。

#### 指令3：xz/unxz

- **功能**：单文件xz格式压缩/解压，压缩比最高，速度最慢，占用CPU资源较多，适合对压缩比要求极高、不紧急的场景（如长期备份），默认删除原文件。

- **核心参数**：
                  -k：保留原文件；

- -d：解压文件（等同于unxz）；

- -0~-9：压缩级别（默认6，0无压缩，9压缩比最高）。

**实操示例**：
                  `
## 高压缩比压缩，保留原文件
xz -9 -k backup.dat  # 生成backup.dat.xz，保留原文件
## 解压文件
unxz backup.dat.xz  # 解压为backup.dat，删除压缩包
xz -d backup.dat.xz  # 与unxz功能一致
## 快速压缩（低级别）
xz -2 -k largefile.dat
` `                      `

**风险等级**：低

**注意事项**：压缩大文件时耗时久、CPU占用高，建议在非业务高峰执行；仅支持单文件压缩，目录需结合tar使用；保留原文件时需确保磁盘空间充足。

**依赖条件**：无，Ubuntu 24.04默认预装xz工具。

### 跨平台压缩与解压（zip/unzip）

#### 指令：zip/unzip

- **功能**：跨平台zip格式压缩/解压，支持多文件/目录打包压缩，兼容Windows、macOS系统，默认保留原文件，压缩比中等，是跨系统文件传输的首选格式。

- **核心参数**：zip：-r 递归压缩目录；-q 静默压缩（不显示过程）；-m 压缩后删除原文件；

- unzip：-d 目录 解压到指定目录；-l 查看压缩包内容；-o 强制覆盖文件（无提示）；-j 仅解压文件（忽略目录结构）。

**实操示例**：
                  `# 安装zip/unzip工具包
sudo apt install -y zip unzip
## 压缩文件/目录
zip -r data.zip /home/data  # 递归压缩目录为data.zip
zip -q test.zip test1.txt test2.txt  # 静默压缩多个文件
zip -m docs.zip docs/  # 压缩后删除原目录docs/
## 解压文件
unzip data.zip  # 解压到当前目录
unzip data.zip -d /tmp/data  # 解压到指定目录
unzip -l data.zip  # 查看压缩包内容（不解压）
unzip -o data.zip  # 强制覆盖现有文件
unzip -j data.zip  # 仅解压文件，忽略原目录结构
` `                      `

**风险等级**：低

**注意事项**：zip压缩目录时必须加-r参数，否则仅压缩目录本身（不含内容）；跨系统传输时需注意文件名编码，避免中文乱码；强制覆盖（-o）需谨慎，避免误删重要文件。

**依赖条件**：需安装zip/unzip工具包，通过apt命令安装即可。

### 冷门实用工具（7z）

#### 工具：7z

- **功能**：7z格式压缩/解压工具，支持多种格式（7z、zip、rar、tar等），压缩比极高（高于xz），支持加密压缩，适用于对压缩比和安全性要求高的场景，是冷门但实用的补充工具。

- **核心参数**：a：创建压缩包（压缩）；

- x：解压文件（保留目录结构）；

- -t格式：指定压缩格式（如-t7z、-tzip）；

- -p密码：设置压缩包密码（加密）；

- -mx=9：最高压缩级别（默认6）。

**实操示例**：
                  `
## 安装7z工具包
sudo apt install -y p7zip-full
## 7z格式高压缩比压缩
7z a -mx=9 -t7z backup.7z /home/data  # 最高级别压缩目录为7z包
## 加密压缩（设置密码）
7z a -p123456 -t7z secret.7z sensitive.txt  # 密码123456
## 解压7z文件
7z x backup.7z  # 保留目录结构解压
7z x secret.7z -p123456  # 输入密码解压
## 解压rar文件（兼容格式）
7z x files.rar
## 查看压缩包内容
7z l backup.7z
` `                      `

**风险等级**：低

**注意事项**：7z压缩速度极慢，高压缩级别下占用大量CPU和时间，仅适用于非紧急备份；密码压缩需妥善保管密码，丢失后无法解压；解压rar格式时需安装p7zip-full（而非p7zip）。

**依赖条件**：需安装p7zip-full工具包，通过apt命令安装。

### 压缩解压常见问题排查

- **压缩包损坏无法解压**：使用tar的--checkpoint参数验证完整性，或通过7z工具尝试修复（7z r backup.7z），重要文件建议备份多个副本。

- **解压后文件属性丢失**：优先使用tar工具（保留属性），避免使用zip（默认不保留权限）；tar解压时确保无--strip-components等剥离属性的参数。

- **中文文件名乱码**：zip解压时添加-O GBK参数（unzip -O GBK data.zip），适配Windows系统的中文编码。

- **大文件压缩耗时久**：平衡压缩比与速度，选择gzip或低级别xz压缩，避开业务高峰执行，或使用后台任务（nohup tar -zcvf data.tar.gz /home/data &）。

# 11-文本处理.md

![License: MIT](https://img.shields.io/badge/License-MIT-yellow.svg)

## 📌 章节简介

涵盖Ubuntu 24.04 LTS系统核心文本处理工具，包括文本查看、编辑、过滤、替换、格式化等操作，适用于配置文件修改、日志分析、数据提取、文本格式化等运维场景。包含vi/vim、sed、awk等核心工具及冷门实用工具，兼顾基础操作与高效运维技巧，是日常文本处理的必备模块。

## 🔧 核心指令清单

|指令/工具|核心功能|风险等级|依赖条件|
|---|---|---|---|
|cat|查看文本文件内容、合并文件|低|无，默认预装|
|more/less|分页查看大文本文件，less功能更全面|低|无，默认预装|
|head/tail|查看文件首尾内容，tail支持实时跟踪|低|无，默认预装|
|vi/vim|文本编辑，支持多模式、语法高亮、批量操作|中|无，默认预装vi，vim需安装vim包|
|sed|流编辑器，批量文本替换、删除、插入|中|无，默认预装|
|awk|文本分析处理，按字段提取、统计、过滤|低|无，默认预装gawk（兼容awk）|
|grep|文本关键字过滤，支持正则表达式|低|无，默认预装|
|wc|统计文本行数、单词数、字节数|低|无，默认预装|
|cut/paste|cut提取指定字段，paste合并多个文件内容|低|无，默认预装|
|sort/uniq|sort排序文本，uniq去除重复行|低|无，默认预装|
|column（冷门实用）|格式化文本为表格形式，优化输出可读性|低|无，默认预装util-linux工具包|
|fmt（冷门实用）|格式化文本段落，调整行宽、对齐方式|低|无，默认预装coreutils工具包|
## 📋 详细操作指南

### 文本查看工具

#### 指令1：cat

- **功能**：查看文本文件完整内容，支持合并多个文件内容输出，也可用于创建简单文本文件。

- **参数**：
  -n：显示行号，包括空行；

- -b：显示行号，仅非空行编号；

- -s：压缩连续空行为一行。

**实操示例**：
  `cat test.txt  # 查看文件内容
cat -b test.txt  # 显示非空行号
cat file1.txt file2.txt > merge.txt  # 合并两个文件到merge.txt
cat > new.txt << EOF  # 创建文本文件，EOF为结束标记
hello ubuntu
this is a new file
` `EOF`

**风险等级**：低

**注意事项**：不适合查看超大文件（会瞬间输出全部内容），优先使用less/more；创建文件时EOF需单独成行，避免内容遗漏。

**依赖条件**：无，默认预装coreutils工具包。

#### 指令2：more/less

- **功能**：分页查看大文本文件，more仅支持向下翻页，less支持上下翻页、搜索等更多功能，是运维首选分页工具。

- **核心操作（less专属）**：
  空格键：向下翻一页；

- ↑/↓键：上下移动一行；

- /关键字：向下搜索关键字，n下一个、N上一个；

- q：退出查看模式。

**实操示例**：
  `more /var/log/syslog  # 分页查看系统日志，按空格翻页
less /etc/config/file.conf  # 高级分页查看，支持搜索
` `less +/error /var/log/nginx/error.log  # 打开文件直接定位到error关键字`

**风险等级**：低

**注意事项**：more查看完毕后自动退出，less需手动按q退出；处理超大日志文件时，less加载速度优于cat和more。

**依赖条件**：无，默认预装coreutils工具包。

#### 指令3：head/tail

- **功能**：head查看文件开头内容，tail查看文件结尾内容，tail -f可实时跟踪文件更新，常用于日志监控。

- **参数**：
  -n 行数：指定查看行数（默认10行）；

- -f：实时跟踪文件新增内容（tail专属）；

- -F：tail -f增强版，文件被轮转后自动重新跟踪。

**实操示例**：
  `head -n 20 test.txt  # 查看文件前20行
tail -n 15 log.txt  # 查看文件最后15行
tail -f /var/log/auth.log  # 实时跟踪认证日志
` `tail -F /var/log/nginx/access.log  # 跟踪日志，支持文件轮转`

**风险等级**：低

**注意事项**：实时跟踪时按Ctrl+C退出；结合grep可过滤特定内容（如tail -f log.txt | grep "error"）。

**依赖条件**：无，默认预装coreutils工具包。

### 文本编辑工具（vi/vim）

#### 工具：vi/vim

- **功能**：vi是基础文本编辑器，vim是增强版，支持语法高亮、代码补全、多窗口编辑、批量操作等功能，是运维修改配置文件的核心工具。Ubuntu默认预装vi，需手动安装vim获得增强功能。

- **核心模式**：
  命令模式：打开文件默认进入，可执行保存、退出、复制、删除等操作；

- 插入模式：按i（光标前插入）、I（行首插入）、a（光标后插入）、A（行尾插入）进入，可编辑文本；

- 末行模式：按:进入，可执行保存退出（wq）、强制退出（q!）、批量替换等命令。

**常用操作**：
  命令模式：yy复制一行、dd删除一行、p粘贴、u撤销、Ctrl+r重做；

末行模式：:w保存、:q退出、:wq保存退出、:q!强制退出、:%s/旧内容/新内容/g批量替换所有内容。

**实操示例**：
  `sudo apt install -y vim  # 安装vim
vim test.conf  # 打开文件（默认命令模式）
# 编辑流程：按i进入插入模式→编辑文本→按Esc返回命令模式→按:进入末行模式→输入wq保存退出
vim +100 test.txt  # 打开文件并定位到第100行
:%s/old_ip/new_ip/g  # 批量替换文件中所有old_ip为new_ip
` `:set nu  # 显示行号，:set nonu隐藏行号`

**风险等级**：中

**注意事项**：修改系统配置文件建议加sudo（如vim /etc/fstab）；误操作时可通过u撤销，未保存退出用:q!；批量替换前建议备份文件，避免替换错误。

**依赖条件**：vi默认预装，vim需安装vim包，通过apt命令即可安装。

### 文本过滤与处理工具

#### 指令1：sed

- **功能**：流编辑器，无需打开文件即可批量处理文本，支持替换、删除、插入、追加等操作，常与管道结合使用，适用于批量修改配置文件、过滤日志内容。

- **核心参数**：
  -i：直接修改原文件（不加则仅输出结果，不修改原文件）；

- -e：执行多个编辑命令；

- s/旧内容/新内容/：替换命令，g表示全局替换，i表示忽略大小写。

**实操示例**：
  `sed 's/error/ERROR/' log.txt  # 替换每行第一个error为ERROR，不修改原文件
sed 's/old/new/g' test.txt  # 全局替换所有old为new
sed -i.bak 's/ip=192.168.1.1/ip=192.168.1.2/' config.conf  # 修改原文件，备份为config.conf.bak
sed '/^#/d' config.conf  # 删除所有以#开头的注释行
sed '3a new line' test.txt  # 在第3行后追加new line内容
` `cat log.txt | sed -n '/success/p'  # 过滤出包含success的行`

**风险等级**：中

**注意事项**：使用-i参数修改文件时，建议加.bak备份原文件（如-i.bak），避免误修改无法恢复；特殊字符（如/、&）需转义（加\）。

**依赖条件**：无，Ubuntu 24.04默认预装sed工具。

#### 指令2：awk

- **功能**：强大的文本分析工具，按字段分割文本（默认空格/制表符），支持条件判断、循环、统计等操作，常用于从日志、表格中提取特定字段、统计数据。

- **核心语法**：awk '条件{动作}' 文件名，$0表示整行，$1-$n表示第1-n个字段，NF表示字段总数，NR表示行号。

- **实操示例**：
  `awk '{print $1,$3}' test.txt  # 打印每行第1和第3个字段
awk -F ',' '{print $2}' data.csv  # 以逗号为分隔符，打印第2个字段（处理CSV文件）
awk '/error/ {print NR,$0}' log.txt  # 打印包含error的行号和内容
awk 'NF>5' test.txt  # 打印字段数大于5的行
` `awk '{sum+=$1} END{print sum}' num.txt  # 统计第一列所有数字的和`

- **风险等级**：低

- **注意事项**：分隔符可通过-F参数指定（如-F ':'处理/etc/passwd文件）；动作语句需用{}包裹，END表示所有行处理完毕后执行。

- **依赖条件**：无，Ubuntu 24.04默认预装gawk（兼容标准awk，功能更丰富）。

#### 指令3：wc

- **功能**：统计文本文件的行数、单词数、字节数，常用于快速了解文件规模，或结合其他命令做条件判断。

- **参数**：
  -l：仅统计行数；

- -w：仅统计单词数；

- -c：仅统计字节数；

- -m：统计字符数（含中文）。

**实操示例**：
  `wc test.txt  # 统计行数、单词数、字节数（默认输出）
wc -l /var/log/syslog  # 统计系统日志行数
cat test.txt | wc -w  # 统计文本单词数
` `wc -m chinese.txt  # 统计中文字符数`

**风险等级**：低

**注意事项**：单词以空格/制表符分隔，连续空格视为一个分隔符；统计行数时，空文件行数为0。

**依赖条件**：无，默认预装coreutils工具包。

#### 指令4：cut/paste

- **功能**：cut用于从文本中提取指定字段或字符范围，paste用于合并多个文件的对应行内容，适用于文本拆分与整合。

- **核心参数**：
  cut：-d 分隔符（指定字段分隔符）、-f 字段号（提取指定字段）、-c 字符范围（提取指定字符）；

- paste：-d 分隔符（指定合并分隔符，默认制表符）、-s（串行合并，而非并行）。

**实操示例**：
  `cut -d ':' -f 1,6 /etc/passwd  # 以:为分隔符，提取第1和第6字段（用户名和家目录）
cut -c 1-5 test.txt  # 提取每行前5个字符
paste file1.txt file2.txt > merge.txt  # 合并两个文件，对应行用制表符分隔
paste -d ',' file1.txt file2.txt  # 以逗号为分隔符合并文件
` `paste -s file1.txt file2.txt  # 串行合并，先输出file1所有行，再输出file2`

**风险等级**：低

**注意事项**：cut提取字段时，若字段不存在则输出空；paste合并时，文件行数不一致，多余行单独输出。

**依赖条件**：无，默认预装coreutils工具包。

#### 指令5：sort/uniq

- **功能**：sort对文本行进行排序（默认字典序），uniq去除文本中的重复行（需先排序，否则仅去连续重复行），常结合使用做去重排序。

- **核心参数**：
  sort：-n（数字排序）、-r（逆序排序）、-k 字段（按指定字段排序）、-t 分隔符（指定字段分隔符）；

- uniq：-c（统计重复次数）、-u（仅显示唯一行）、-d（仅显示重复行）。

**实操示例**：
  `sort test.txt  # 字典序排序
sort -n num.txt  # 数字排序
sort -t ':' -k 3 -n /etc/passwd  # 以:为分隔符，按第3字段（UID）数字排序
sort test.txt | uniq  # 排序后去重
sort test.txt | uniq -c  # 统计每行重复次数
` `sort test.txt | uniq -u  # 仅显示不重复的行`

**风险等级**：低

**注意事项**：uniq仅能去除连续重复行，必须先通过sort排序使重复行集中；数字排序需加-n参数，否则按字典序排序（如10<2）。

**依赖条件**：无，默认预装coreutils工具包。

### 冷门实用工具

#### 工具1：column

- **功能**：将杂乱的文本格式化为规整的表格形式，自动按分隔符对齐，适用于优化命令输出结果（如ls -l、cat /etc/passwd）的可读性。

- **核心参数**：
  -t：自动创建表格，根据输入内容调整列宽；

- -s 分隔符：指定字段分隔符（默认空格/制表符）。

**实操示例**：
  `cat /etc/passwd | column -t -s ':'  # 以:为分隔符，格式化/etc/passwd为表格
ls -l | column -t  # 优化ls -l输出，对齐列
` `echo -e "name,age,city\nzhangsan,25,beijing\nlisi,30,shanghai" | column -t -s ','  # 格式化CSV内容为表格`

**风险等级**：低

**注意事项**：分隔符需与文本实际分隔符一致，否则格式化效果异常；适合字段清晰的文本，杂乱无章的文本可能无法正常对齐。

**依赖条件**：无，默认预装util-linux工具包。

#### 工具2：fmt

- **功能**：格式化文本段落，自动调整行宽、合并零散文本、对齐段落，适用于整理文档、配置文件注释，使文本更易读。

- **核心参数**：
  -w 宽度：指定每行最大字符数（默认75）；

- -u：统一空格，将多个空格替换为一个空格；

- -t：首行缩进，使段落更规整。

**实操示例**：
  `fmt test.txt  # 默认格式化文本，行宽75
fmt -w 50 test.txt  # 设定行宽为50
fmt -u -t note.txt  # 统一空格并首行缩进，整理注释文档
` `cat messy.txt | fmt -w 60 > neat.txt  # 格式化杂乱文本并保存到新文件`

**风险等级**：低

**注意事项**：会合并连续空行为一个空行，若需保留多空行需谨慎；不适用于代码文件（可能破坏缩进结构），仅适合纯文本段落。

**依赖条件**：无，默认预装coreutils工具包。

# 12-远程管理.md

![License: MIT](https://img.shields.io/badge/License-MIT-yellow.svg)

## 📌 章节简介

涵盖Ubuntu 24.04 LTS系统远程管理核心技术，包括SSH协议连接、密钥认证、远程文件传输、服务配置优化及冷门实用工具，适用于跨主机运维、服务器远程管控、批量操作等场景。重点强化远程连接安全性，规避密码泄露、未授权访问风险，是分布式运维环境的必备模块。

## 🔧 核心指令清单

|指令/工具|核心功能|风险等级|依赖条件|
|---|---|---|---|
|ssh|通过SSH协议远程登录主机|中|无，默认预装openssh-client|
|sshd|SSH服务端程序，提供远程登录服务|中|需安装openssh-server，默认自启|
|ssh-keygen|生成SSH密钥对（公钥/私钥）|低|无，依赖openssh-client|
|ssh-copy-id|将本地公钥分发至远程主机，配置免密登录|低|无，依赖openssh-client|
|scp|基于SSH协议远程复制文件/目录|低|无，依赖openssh-client/server|
|sftp|基于SSH的安全文件传输协议，交互式操作|低|无，依赖openssh-client/server|
|mosh（冷门实用）|基于UDP的远程终端，网络不稳定时优于SSH|低|需安装mosh工具包|
|autossh（冷门实用）|自动重连SSH会话，保持长期连接稳定|低|需安装autossh工具包|
## 📋 详细操作指南

### SSH基础配置与登录

#### 工具：ssh/sshd

- **功能**：ssh是客户端工具，用于远程登录SSH服务端；sshd是服务端程序，监听指定端口（默认22），提供加密远程访问，替代不安全的telnet协议。Ubuntu 24.04默认预装客户端，服务端需手动安装。

- **核心参数（ssh）**：
  -p 端口号：指定远程主机SSH端口（默认22）；
  -l 用户名：指定登录远程主机的用户名；
  -o StrictHostKeyChecking=no：首次登录跳过主机密钥验证（批量操作常用）；
  -X：启用X11转发，支持远程运行图形程序。

- **服务端配置（sshd）**：主配置文件/etc/ssh/sshd_config，核心配置项：
  Port 22：修改监听端口（建议非默认端口，提升安全性）；
  PermitRootLogin no：禁止root用户直接登录；
  PasswordAuthentication no：禁用密码登录，仅允许密钥认证；
  AllowUsers testuser admin：仅允许指定用户登录（白名单机制）。

**实操示例**：
`# 1. 安装并启动SSH服务端
sudo apt install -y openssh-server
sudo systemctl start sshd
sudo systemctl enable sshd  # 设置开机自启
sudo systemctl status sshd  # 检查服务状态

# 2. 基础远程登录
ssh testuser@192.168.1.100  # 用户名+IP登录，默认端口22
ssh -p 2222 admin@192.168.1.101  # 指定端口登录
ssh -l testuser 192.168.1.100  # -l参数指定用户名

# 3. 服务端配置优化（安全加固）
sudo cp /etc/ssh/sshd_config /etc/ssh/sshd_config.bak  # 备份配置文件
sudo sed -i 's/#Port 22/Port 2222/' /etc/ssh/sshd_config  # 修改监听端口为2222
sudo sed -i 's/PermitRootLogin yes/PermitRootLogin no/' /etc/ssh/sshd_config  # 禁止root登录
sudo systemctl restart sshd  # 重启服务使配置生效
` `sudo ufw allow 2222/tcp  # 防火墙开放新端口（若启用ufw）`

**风险等级**：中

**注意事项**：修改sshd配置前必须备份原文件，避免配置错误导致无法远程连接；修改端口后需同步更新防火墙规则；禁止密码登录前需确保密钥认证已配置正常，否则会锁死登录权限。

**依赖条件**：客户端依赖openssh-client（默认预装），服务端依赖openssh-server（需apt安装）。

### SSH密钥认证（免密登录）

#### 工具：ssh-keygen/ssh-copy-id

- **功能**：通过非对称加密（公钥/私钥）实现SSH免密登录，私钥保存在本地主机，公钥部署至远程主机，安全性远高于密码登录，适用于批量运维、自动化脚本执行场景。

- **核心逻辑**：本地生成密钥对→将公钥上传至远程主机~/.ssh/authorized_keys→登录时本地用私钥签名，远程用公钥验证，验证通过即可登录。

**实操示例**：
`# 1. 本地生成密钥对（默认RSA算法，4096位长度）
ssh-keygen -t rsa -b 4096 -C "testuser@local"  # -C添加注释，便于识别
# 执行后按回车，默认保存路径~/.ssh/id_rsa（私钥）、~/.ssh/id_rsa.pub（公钥）
# 可设置密钥密码（passphrase），增强安全性，避免私钥泄露风险

# 2. 分发公钥至远程主机（两种方式）
# 方式一：用ssh-copy-id自动分发（推荐，自动配置权限）
ssh-copy-id -p 2222 testuser@192.168.1.100  # 指定端口和用户
# 方式二：手动复制公钥（适用于无ssh-copy-id场景）
cat ~/.ssh/id_rsa.pub | ssh -p 2222 testuser@192.168.1.100 "mkdir -p ~/.ssh && cat >> ~/.ssh/authorized_keys && chmod 600 ~/.ssh/authorized_keys"

# 3. 验证免密登录
ssh -p 2222 testuser@192.168.1.100  # 无需输入密码即可登录

# 4. 密钥权限加固（关键，权限过宽会导致认证失败）
chmod 700 ~/.ssh  # 本地和远程主机的.ssh目录权限
chmod 600 ~/.ssh/id_rsa  # 本地私钥权限（严格保密，仅所有者可读写）
chmod 644 ~/.ssh/id_rsa.pub  # 本地公钥权限
` `chmod 600 ~/.ssh/authorized_keys  # 远程主机授权文件权限`

**风险等级**：低

**注意事项**：私钥文件（id_rsa）需严格保密，禁止泄露给他人，建议设置密钥密码；远程主机authorized_keys文件权限必须为600，.ssh目录为700，否则sshd会拒绝读取；多主机管理可通过~/.ssh/config配置别名，简化登录命令。

**依赖条件**：依赖openssh-client工具包（默认预装），远程主机需启动sshd服务。

### 远程文件传输

#### 指令1：scp

- **功能**：基于SSH协议的远程文件/目录复制工具，加密传输数据，语法与cp类似，支持本地与远程、远程与远程之间的复制，适用于快速传输少量文件。

- **核心参数**：
  -r：递归复制目录及所有子内容；
  -P 端口号：指定远程主机SSH端口（注意大写，与ssh的-p区分）；
  -p：保留文件原有属性（权限、时间戳）；
  -q：静默传输，不显示进度信息。

**实操示例**：
`# 1. 本地文件复制到远程主机
scp -P 2222 -p test.txt testuser@192.168.1.100:/home/testuser/
# 2. 本地目录复制到远程主机
scp -P 2222 -r /home/local/data testuser@192.168.1.100:/data/
# 3. 远程文件复制到本地
scp -P 2222 testuser@192.168.1.100:/home/testuser/logs.txt /tmp/
# 4. 远程目录复制到本地
scp -P 2222 -r testuser@192.168.1.100:/data/backup /home/local/
# 5. 远程主机之间复制文件（需本地可同时访问两台主机）
` `scp -P 2222 testuser@192.168.1.100:/file1.txt testuser@192.168.1.101:/home/testuser/`

**风险等级**：低

**注意事项**：复制目录必须加-r参数；传输大文件时无进度条（可结合pv工具显示进度）；密钥认证生效后，scp无需输入密码即可传输，适合自动化脚本。

#### 指令2：sftp

- **功能**：基于SSH的安全文件传输协议，提供交互式操作界面，支持文件上传、下载、创建目录、删除等操作，适用于频繁手动传输文件的场景，兼容性优于scp。

- **常用交互命令**：
  put 本地文件：上传文件到远程主机；
  get 远程文件：下载文件到本地主机；
  ls/ll：查看远程主机当前目录内容；
  lls：查看本地主机当前目录内容；
  mkdir 目录名：在远程主机创建目录；
  rm 文件名：删除远程主机文件；
  exit/quit：退出sftp会话。

**实操示例**：
`# 1. 连接远程主机sftp服务
sftp -P 2222 testuser@192.168.1.100
# 2. 上传文件
sftp> put /home/local/test.txt /home/testuser/  # 本地文件上传到远程
sftp> put -r /home/local/data /data/  # 本地目录上传到远程（需支持递归）
# 3. 下载文件
sftp> get /home/testuser/logs.txt /tmp/  # 远程文件下载到本地
sftp> get -r /data/backup /home/local/  # 远程目录下载到本地
# 4. 交互操作
sftp> ls  # 查看远程目录
sftp> lls  # 查看本地目录
sftp> mkdir newdir  # 远程创建目录
sftp> rm oldfile.txt  # 远程删除文件
` `sftp> exit  # 退出会话`

**风险等级**：低

**注意事项**：sftp默认使用SSH密钥认证，无需额外配置；上传下载目录时需确保服务端支持递归（大部分版本默认支持）；传输大文件时按Ctrl+T可查看传输进度。

### 冷门实用工具

#### 工具1：mosh

- **功能**：Mobile Shell，基于UDP协议的远程终端工具，解决SSH在网络不稳定（如无线网络、移动网络）下频繁断开、卡顿的问题，支持漫游（切换网络后保持连接）、本地回显，体验优于SSH。

- **核心优势**：网络中断后自动重连，无需手动重新登录；仅传输变化的数据，带宽占用低；支持UTF-8字符和256色终端。

**实操示例**：
`# 1. 安装mosh（本地和远程主机都需安装）
sudo apt install -y mosh
# 2. 远程登录（默认使用SSH端口协商，也可指定端口）
mosh testuser@192.168.1.100  # 默认端口，基于SSH认证
mosh -p 60001 testuser@192.168.1.100  # 指定UDP端口（需开放防火墙）
# 3. 结合SSH参数使用
` `mosh --ssh="ssh -p 2222" testuser@192.168.1.100  # 远程SSH端口为2222时`

**风险等级**：低

**注意事项**：mosh依赖UDP协议，需确保本地和远程主机之间UDP端口（默认60000-61000）开放；不支持X11转发，若需远程图形程序仍需使用SSH；网络稳定场景下与SSH体验差异不大。

#### 工具2：autossh

- **功能**：自动重连SSH会话的工具，通过定时发送心跳包检测连接状态，若连接断开则自动重新建立，适用于需要长期保持SSH连接的场景（如端口转发、隧道代理）。

- **核心参数**：
  -M 监控端口：指定一个本地端口，用于发送心跳包检测连接；
  -f：后台运行autossh进程；
  -N：仅建立连接，不执行远程命令（端口转发常用）。

**实操示例**：
`# 1. 安装autossh
sudo apt install -y autossh
# 2. 基础自动重连登录
autossh -M 20000 -f -N -o "StrictHostKeyChecking=no" testuser@192.168.1.100
# 3. 结合端口转发（本地端口转发，后台保持连接）
autossh -M 20001 -f -N -L 8080:localhost:80 testuser@192.168.1.100
# 解释：本地8080端口转发到远程主机的80端口，断开后自动重连
# 4. 查看autossh进程
ps aux | grep autossh
# 5. 停止autossh进程
` `kill -9 进程ID`

**风险等级**：低

**注意事项**：-M指定的监控端口需未被占用，且本地与远程主机之间可通信；后台运行时建议配合systemd创建服务，实现开机自启；密钥认证是前提，避免频繁输入密码。

### SSH高级配置（~/.ssh/config）

- **功能**：通过本地~/.ssh/config文件配置SSH连接别名、端口、用户名、密钥路径等信息，简化多主机登录命令，无需每次输入完整参数，提升运维效率。

- **配置格式**：每个主机配置独立区块，支持通配符，配置项区分大小写。

**实操示例**：
`# 1. 创建并编辑配置文件
mkdir -p ~/.ssh
vim ~/.ssh/config
# 2. 添加配置内容（示例为两台主机配置）
Host server1
  HostName 192.168.1.100
  Port 2222
  User testuser
  IdentityFile ~/.ssh/id_rsa_server1
  StrictHostKeyChecking no
  ServerAliveInterval 30  # 每30秒发送心跳包，保持连接

Host server2
  HostName 192.168.1.101
  Port 22
  User admin
  IdentityFile ~/.ssh/id_rsa_admin
  ForwardX11 yes  # 启用X11转发

Host *
  ServerAliveCountMax 5  # 心跳包失败5次后断开连接
  Compression yes  # 启用压缩，减少带宽占用

# 3. 配置文件权限加固（必须设置，否则ssh会忽略配置）
chmod 600 ~/.ssh/config
chmod 700 ~/.ssh

# 4. 简化登录（直接使用别名）
ssh server1
` `ssh server2`

**风险等级**：低

**注意事项**：配置文件权限必须为600，否则SSH客户端会因权限过宽拒绝加载；IdentityFile可指定不同主机的密钥文件，实现多密钥管理；通配符Host *的配置对所有主机生效，优先级低于单独主机配置。
> （注：文档部分内容可能由 AI 生成）